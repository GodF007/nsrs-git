# NSRS-Web 手动部署指南

## 📦 本地打包

### 1. 执行打包脚本

```cmd
# Windows用户 (推荐使用PowerShell版本)
build-for-deploy.ps1

# 或者使用批处理版本
build-for-deploy.bat
```

**重要修复：** 已修复Tomcat部署时的404问题：
- ✅ 修改了Vite配置，使用相对路径（`base: './`）
- ✅ 修复了favicon.png的路径问题
- ✅ 配置了正确的SPA路由重定向

**如果仍遇到问题，请检查：**
1. Tomcat版本是否支持（建议8.5+）
2. WAR文件是否正确部署到webapps目录
3. 访问地址是否正确：`http://server-ip:8080/nsrs/`

脚本会自动完成：
- 清理旧文件
- 构建项目
- 创建 WAR 包

### 2. 打包结果

打包完成后，会在项目根目录生成：
- `nsrs.war` - 可部署的 WAR 文件

## 🚀 手动部署步骤

### 第一步：准备工作

1. **备份现有应用**（如果存在）
   ```bash
   sudo cp -r /opt/tomcat/webapps/nsrs /opt/tomcat/webapps/nsrs.backup.$(date +%Y%m%d_%H%M%S)
   ```

2. **将 WAR 文件传输到服务器**
   ```bash
   # 使用 SCP
   scp nsrs.war user@server-ip:~/
   
   # 或使用 FTP/SFTP 工具上传
   ```

### 第二步：部署到 Tomcat

1. **停止 Tomcat 服务**
   ```bash
   sudo systemctl stop tomcat
   # 或
   sudo /opt/tomcat/bin/shutdown.sh
   ```

2. **清理旧应用**
   ```bash
   # 删除旧的应用目录
   sudo rm -rf /opt/tomcat/webapps/nsrs
   
   # 删除旧的 WAR 文件（如果存在）
   sudo rm -f /opt/tomcat/webapps/nsrs.war
   ```

3. **部署新应用**
   ```bash
   # 移动 WAR 文件到 webapps 目录
   sudo mv ~/nsrs.war /opt/tomcat/webapps/
   
   # 设置正确的权限
   sudo chown tomcat:tomcat /opt/tomcat/webapps/nsrs.war
   ```

4. **启动 Tomcat 服务**
   ```bash
   sudo systemctl start tomcat
   # 或
   sudo /opt/tomcat/bin/startup.sh
   ```

### 第三步：验证部署

1. **等待应用解压**
   - Tomcat 启动后会自动解压 WAR 文件
   - 通常需要 1-2 分钟

2. **检查应用状态**
   ```bash
   # 检查 Tomcat 日志
   tail -f /opt/tomcat/logs/catalina.out
   
   # 检查应用目录是否创建
   ls -la /opt/tomcat/webapps/nsrs
   ```

3. **访问应用**
   - 浏览器访问：`http://服务器IP:8080/nsrs/`
   - 或使用 curl 测试：`curl -I http://服务器IP:8080/nsrs/`

## 🔧 常见问题处理

### 问题1：应用无法访问

**可能原因：**
- Tomcat 服务未启动
- 防火墙阻止 8080 端口
- WAR 文件解压失败

**解决方法：**
```bash
# 检查 Tomcat 状态
sudo systemctl status tomcat

# 检查端口是否监听
sudo netstat -tlnp | grep 8080

# 检查防火墙
sudo firewall-cmd --list-ports
sudo firewall-cmd --add-port=8080/tcp --permanent
sudo firewall-cmd --reload
```

### 问题2：页面显示 404

**可能原因：**
- WAR 文件名不正确
- 应用未完全解压
- web.xml 配置问题

**解决方法：**
```bash
# 检查应用目录
ls -la /opt/tomcat/webapps/

# 检查应用内容
ls -la /opt/tomcat/webapps/nsrs/

# 重新部署
sudo systemctl stop tomcat
sudo rm -rf /opt/tomcat/webapps/nsrs*
# 重新放置 WAR 文件并启动
```

### 问题3：静态资源加载失败

**可能原因：**
- 路径配置不正确
- 缓存问题

**解决方法：**
- 强制刷新浏览器 (Ctrl+F5)
- 检查浏览器开发者工具的网络面板
- 确认 vite.config.ts 中的 base 路径配置

## 📋 部署检查清单

### 部署前检查
- [ ] 本地构建成功
- [ ] WAR 文件生成正常
- [ ] 服务器连接正常
- [ ] Tomcat 服务运行正常
- [ ] 有足够的磁盘空间

### 部署后检查
- [ ] Tomcat 服务启动成功
- [ ] WAR 文件自动解压
- [ ] 应用目录创建完成
- [ ] 首页可以正常访问
- [ ] 静态资源加载正常
- [ ] 路由跳转功能正常

## 🔄 更新部署

对于后续的应用更新，可以简化流程：

1. **本地重新打包**
   ```cmd
   build-for-deploy.bat
   ```

2. **快速部署**
   ```bash
   # 上传新的 WAR 文件
   scp nsrs.war user@server-ip:~/
   
   # 在服务器上执行
   sudo systemctl stop tomcat
   sudo rm -rf /opt/tomcat/webapps/nsrs
   sudo mv ~/nsrs.war /opt/tomcat/webapps/
   sudo chown tomcat:tomcat /opt/tomcat/webapps/nsrs.war
   sudo systemctl start tomcat
   ```

## 📞 技术支持

如果遇到问题，请提供以下信息：
- 操作系统版本
- Tomcat 版本
- Java 版本
- 错误日志内容
- 部署步骤详情

---

**注意：** 生产环境部署建议先在测试环境验证，确保应用功能正常后再部署到生产环境。