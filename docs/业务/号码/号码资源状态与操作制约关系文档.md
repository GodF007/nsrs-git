# 号码资源状态与操作制约关系文档

## 1. 概述

本文档基于现有系统实现，详细说明号码资源管理系统中状态与操作之间的相互制约关系。系统采用严格的状态机模式，确保号码资源在不同状态间的安全转换。

## 2. 状态定义

### 2.1 号码状态枚举 (NumberStatusEnum)

| 状态码 | 中文名称 | 英文名称 | 描述 |
|--------|----------|----------|------|
| 1 | 空闲 | Idle | 号码未被使用，可进行预留或分配 |
| 2 | 预留 | Reserved | 号码已被预留，暂时锁定但未正式分配 |
| 3 | 已分配 | Assigned | 号码已分配给组织，但未激活 |
| 4 | 已激活 | Activated | 号码已激活，可正常使用 |
| 5 | 已使用 | In Use | 号码正在使用中 |
| 6 | 已冻结 | Frozen | 号码被冻结，暂停使用 |
| 7 | 已锁定 | Locked | 号码被锁定，禁止操作 |

### 2.2 操作类型枚举 (OperationTypeEnum)

| 操作码 | 中文名称 | 英文名称 | 描述 |
|--------|----------|----------|------|
| 1 | 创建 | Create | 创建新的号码资源 |
| 2 | 预留 | Reserve | 预留号码资源 |
| 3 | 分配 | Assign | 分配号码给组织 |
| 4 | 激活 | Activate | 激活已分配的号码 |
| 5 | 冻结 | Freeze | 冻结号码使用 |
| 6 | 解冻 | Unfreeze | 解除号码冻结 |
| 7 | 释放 | Release | 释放号码资源 |
| 8 | 回收 | Recycle | 回收号码资源 |
| 9 | 修改 | Modify | 修改号码信息 |
| 10 | 删除 | Delete | 删除号码资源 |

## 3. 状态转换规则

### 3.1 状态转换矩阵

| 当前状态\操作 | 创建 | 预留 | 分配 | 激活 | 冻结 | 解冻 | 释放 | 回收 | 修改 | 删除 |
|---------------|------|------|------|------|------|------|------|------|------|------|
| **空闲(1)** | ❌ | ✅→2 | ✅→3 | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ |
| **预留(2)** | ❌ | ❌ | ✅→3 | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ | ✅ |
| **已分配(3)** | ❌ | ❌ | ❌ | ✅→4 | ❌ | ❌ | ✅→1 | ✅→1 | ✅ | ❌ |
| **已激活(4)** | ❌ | ❌ | ❌ | ❌ | ✅→6 | ❌ | ✅→1 | ✅→1 | ✅ | ❌ |
| **已使用(5)** | ❌ | ❌ | ❌ | ❌ | ✅→6 | ❌ | ✅→1 | ✅→1 | ✅ | ❌ |
| **已冻结(6)** | ❌ | ❌ | ❌ | ❌ | ❌ | ✅→4 | ✅→1 | ✅→1 | ✅ | ❌ |
| **已锁定(7)** | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ | ✅→1 | ❌ | ❌ |

**说明：**
- ✅ 表示允许的操作
- ❌ 表示禁止的操作
- →X 表示操作后转换到的目标状态

### 3.2 详细状态转换规则

#### 3.2.1 预留操作 (Reserve)
- **前置条件：** 号码状态必须为"空闲(1)"
- **目标状态：** "预留(2)"
- **业务逻辑：** 将空闲号码标记为预留状态，防止其他用户操作
- **实现方法：** `NumberResourceServiceImpl.reserve()`

#### 3.2.2 分配操作 (Assign)
- **前置条件：** 号码状态为"空闲(1)"或"预留(2)"
- **目标状态：** "已分配(3)"
- **业务逻辑：** 将号码分配给指定组织，设置归属组织信息
- **实现方法：** `NumberResourceServiceImpl.assign()`

#### 3.2.3 激活操作 (Activate)
- **前置条件：** 号码状态必须为"已分配(3)"
- **目标状态：** "已激活(4)"
- **业务逻辑：** 激活已分配的号码，可选择绑定ICCID
- **实现方法：** `NumberResourceServiceImpl.activate()`

#### 3.2.4 冻结操作 (Freeze)
- **前置条件：** 号码状态为"已激活(4)"或"已使用(5)"
- **目标状态：** "已冻结(6)"
- **业务逻辑：** 冻结正在使用的号码，暂停服务但保留分配关系
- **实现方法：** `NumberResourceServiceImpl.freeze()`

#### 3.2.5 解冻操作 (Unfreeze)
- **前置条件：** 号码状态必须为"已冻结(6)"
- **目标状态：** "已激活(4)"
- **业务逻辑：** 解除号码冻结，恢复为激活状态
- **实现方法：** `NumberResourceServiceImpl.unfreeze()`
- **注意：** 当前实现固定恢复为"已激活"状态，未记录冻结前状态

#### 3.2.6 释放操作 (Release)
- **前置条件：** 号码状态为"已分配(3)"、"已激活(4)"、"已使用(5)"或"已冻结(6)"
- **目标状态：** "空闲(1)"
- **业务逻辑：** 释放号码资源，清空归属组织和ICCID信息
- **实现方法：** `NumberResourceServiceImpl.release()`

#### 3.2.7 回收操作 (Recycle)
- **前置条件：** 任意状态（无限制）
- **目标状态：** "空闲(1)"
- **业务逻辑：** 强制回收号码资源，清空所有关联信息
- **实现方法：** `NumberResourceServiceImpl.recycle()`
- **注意：** 这是最宽松的操作，可从任意状态回收

## 4. 状态流转图

### 4.1 主要状态流转路径

```svg
<svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
    <style>
      .state-box { fill: #e1f5fe; stroke: #0277bd; stroke-width: 2; }
      .state-text { font-family: Arial, sans-serif; font-size: 12px; text-anchor: middle; }
      .operation-text { font-family: Arial, sans-serif; font-size: 10px; fill: #d32f2f; }
      .arrow { stroke: #333; stroke-width: 2; marker-end: url(#arrowhead); }
      .recycle-arrow { stroke: #f44336; stroke-width: 2; marker-end: url(#arrowhead); stroke-dasharray: 5,5; }
    </style>
  </defs>
  
  <!-- 状态节点 -->
  <!-- 空闲 -->
  <rect x="50" y="50" width="80" height="40" class="state-box" />
  <text x="90" y="75" class="state-text">空闲(1)</text>
  
  <!-- 预留 -->
  <rect x="200" y="50" width="80" height="40" class="state-box" />
  <text x="240" y="75" class="state-text">预留(2)</text>
  
  <!-- 已分配 -->
  <rect x="350" y="50" width="80" height="40" class="state-box" />
  <text x="390" y="75" class="state-text">已分配(3)</text>
  
  <!-- 已激活 -->
  <rect x="500" y="50" width="80" height="40" class="state-box" />
  <text x="540" y="75" class="state-text">已激活(4)</text>
  
  <!-- 已使用 -->
  <rect x="650" y="50" width="80" height="40" class="state-box" />
  <text x="690" y="75" class="state-text">已使用(5)</text>
  
  <!-- 已冻结 -->
  <rect x="500" y="200" width="80" height="40" class="state-box" />
  <text x="540" y="225" class="state-text">已冻结(6)</text>
  
  <!-- 已锁定 -->
  <rect x="350" y="350" width="80" height="40" class="state-box" />
  <text x="390" y="375" class="state-text">已锁定(7)</text>
  
  <!-- 正常流转箭头 -->
  <!-- 空闲 -> 预留 -->
  <line x1="130" y1="70" x2="200" y2="70" class="arrow" />
  <text x="165" y="65" class="operation-text">预留</text>
  
  <!-- 空闲 -> 已分配 -->
  <path d="M 130 80 Q 240 120 350 80" fill="none" class="arrow" />
  <text x="240" y="110" class="operation-text">分配</text>
  
  <!-- 预留 -> 已分配 -->
  <line x1="280" y1="70" x2="350" y2="70" class="arrow" />
  <text x="315" y="65" class="operation-text">分配</text>
  
  <!-- 已分配 -> 已激活 -->
  <line x1="430" y1="70" x2="500" y2="70" class="arrow" />
  <text x="465" y="65" class="operation-text">激活</text>
  
  <!-- 已激活 -> 已使用 -->
  <line x1="580" y1="70" x2="650" y2="70" class="arrow" />
  <text x="615" y="65" class="operation-text">使用</text>
  
  <!-- 已激活 -> 已冻结 -->
  <line x1="540" y1="90" x2="540" y2="200" class="arrow" />
  <text x="555" y="145" class="operation-text">冻结</text>
  
  <!-- 已使用 -> 已冻结 -->
  <path d="M 670 90 Q 620 150 560 200" fill="none" class="arrow" />
  <text x="620" y="140" class="operation-text">冻结</text>
  
  <!-- 已冻结 -> 已激活 -->
  <line x1="520" y1="200" x2="520" y2="90" class="arrow" />
  <text x="505" y="145" class="operation-text">解冻</text>
  
  <!-- 释放操作箭头 -->
  <!-- 已分配 -> 空闲 -->
  <path d="M 350 80 Q 240 140 130 80" fill="none" class="arrow" />
  <text x="240" y="130" class="operation-text">释放</text>
  
  <!-- 已激活 -> 空闲 -->
  <path d="M 500 80 Q 300 160 130 80" fill="none" class="arrow" />
  <text x="300" y="150" class="operation-text">释放</text>
  
  <!-- 已使用 -> 空闲 -->
  <path d="M 650 80 Q 400 180 130 80" fill="none" class="arrow" />
  <text x="400" y="170" class="operation-text">释放</text>
  
  <!-- 已冻结 -> 空闲 -->
  <path d="M 500 220 Q 300 280 130 80" fill="none" class="arrow" />
  <text x="300" y="270" class="operation-text">释放</text>
  
  <!-- 回收操作（虚线箭头，表示可从任意状态回收） -->
  <line x1="240" y1="90" x2="90" y2="90" class="recycle-arrow" />
  <line x1="390" y1="90" x2="90" y2="90" class="recycle-arrow" />
  <line x1="540" y1="90" x2="90" y2="90" class="recycle-arrow" />
  <line x1="690" y1="90" x2="90" y2="90" class="recycle-arrow" />
  <line x1="540" y1="240" x2="90" y2="90" class="recycle-arrow" />
  <line x1="390" y1="350" x2="90" y2="90" class="recycle-arrow" />
  
  <!-- 图例 -->
  <text x="50" y="450" style="font-family: Arial, sans-serif; font-size: 14px; font-weight: bold;">图例：</text>
  <line x1="50" y1="470" x2="100" y2="470" class="arrow" />
  <text x="110" y="475" style="font-family: Arial, sans-serif; font-size: 12px;">正常状态转换</text>
  <line x1="50" y1="490" x2="100" y2="490" class="recycle-arrow" />
  <text x="110" y="495" style="font-family: Arial, sans-serif; font-size: 12px;">回收操作（可从任意状态）</text>
  
  <!-- 标题 -->
  <text x="400" y="30" style="font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; text-anchor: middle;">号码资源状态流转图</text>
</svg>
```

### 4.2 操作决策树

```svg
<svg width="900" height="700" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <marker id="arrowhead2" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
    <style>
      .decision-box { fill: #fff3e0; stroke: #f57c00; stroke-width: 2; }
      .action-box { fill: #e8f5e8; stroke: #388e3c; stroke-width: 2; }
      .error-box { fill: #ffebee; stroke: #d32f2f; stroke-width: 2; }
      .text { font-family: Arial, sans-serif; font-size: 11px; text-anchor: middle; }
      .arrow2 { stroke: #333; stroke-width: 1.5; marker-end: url(#arrowhead2); }
      .yes-text { font-family: Arial, sans-serif; font-size: 10px; fill: #388e3c; }
      .no-text { font-family: Arial, sans-serif; font-size: 10px; fill: #d32f2f; }
    </style>
  </defs>
  
  <!-- 开始 -->
  <ellipse cx="450" cy="30" rx="40" ry="20" class="decision-box" />
  <text x="450" y="35" class="text">开始操作</text>
  
  <!-- 检查号码是否存在 -->
  <rect x="400" y="80" width="100" height="40" class="decision-box" />
  <text x="450" y="105" class="text">号码是否存在？</text>
  
  <!-- 号码不存在 -->
  <rect x="600" y="80" width="100" height="40" class="error-box" />
  <text x="650" y="105" class="text">抛出异常</text>
  
  <!-- 获取当前状态 -->
  <rect x="400" y="160" width="100" height="40" class="action-box" />
  <text x="450" y="185" class="text">获取当前状态</text>
  
  <!-- 状态判断分支 -->
  <rect x="200" y="240" width="80" height="30" class="decision-box" />
  <text x="240" y="260" class="text">空闲(1)</text>
  
  <rect x="300" y="240" width="80" height="30" class="decision-box" />
  <text x="340" y="260" class="text">预留(2)</text>
  
  <rect x="400" y="240" width="80" height="30" class="decision-box" />
  <text x="440" y="260" class="text">已分配(3)</text>
  
  <rect x="500" y="240" width="80" height="30" class="decision-box" />
  <text x="540" y="260" class="text">已激活(4)</text>
  
  <rect x="600" y="240" width="80" height="30" class="decision-box" />
  <text x="640" y="260" class="text">已使用(5)</text>
  
  <rect x="400" y="320" width="80" height="30" class="decision-box" />
  <text x="440" y="340" class="text">已冻结(6)</text>
  
  <rect x="500" y="320" width="80" height="30" class="decision-box" />
  <text x="540" y="340" class="text">已锁定(7)</text>
  
  <!-- 操作类型判断 -->
  <rect x="50" y="400" width="70" height="30" class="action-box" />
  <text x="85" y="420" class="text">预留操作</text>
  
  <rect x="140" y="400" width="70" height="30" class="action-box" />
  <text x="175" y="420" class="text">分配操作</text>
  
  <rect x="230" y="400" width="70" height="30" class="action-box" />
  <text x="265" y="420" class="text">激活操作</text>
  
  <rect x="320" y="400" width="70" height="30" class="action-box" />
  <text x="355" y="420" class="text">冻结操作</text>
  
  <rect x="410" y="400" width="70" height="30" class="action-box" />
  <text x="445" y="420" class="text">解冻操作</text>
  
  <rect x="500" y="400" width="70" height="30" class="action-box" />
  <text x="535" y="420" class="text">释放操作</text>
  
  <rect x="590" y="400" width="70" height="30" class="action-box" />
  <text x="625" y="420" class="text">回收操作</text>
  
  <!-- 成功/失败结果 -->
  <rect x="200" y="500" width="100" height="40" class="action-box" />
  <text x="250" y="525" class="text">操作成功</text>
  
  <rect x="400" y="500" width="100" height="40" class="error-box" />
  <text x="450" y="525" class="text">状态不匹配</text>
  
  <rect x="600" y="500" width="100" height="40" class="error-box" />
  <text x="650" y="525" class="text">抛出异常</text>
  
  <!-- 记录日志和更新统计 -->
  <rect x="200" y="580" width="100" height="40" class="action-box" />
  <text x="250" y="605" class="text">记录操作日志</text>
  
  <rect x="350" y="580" width="100" height="40" class="action-box" />
  <text x="400" y="605" class="text">更新号段统计</text>
  
  <!-- 连接线 -->
  <line x1="450" y1="50" x2="450" y2="80" class="arrow2" />
  
  <line x1="500" y1="100" x2="600" y2="100" class="arrow2" />
  <text x="550" y="95" class="no-text">否</text>
  
  <line x1="450" y1="120" x2="450" y2="160" class="arrow2" />
  <text x="430" y="140" class="yes-text">是</text>
  
  <line x1="450" y1="200" x2="450" y2="240" class="arrow2" />
  
  <!-- 从状态到操作的连接线（简化显示主要路径） -->
  <line x1="240" y1="270" x2="85" y2="400" class="arrow2" />
  <line x1="240" y1="270" x2="175" y2="400" class="arrow2" />
  <line x1="340" y1="270" x2="175" y2="400" class="arrow2" />
  <line x1="440" y1="270" x2="265" y2="400" class="arrow2" />
  <line x1="540" y1="270" x2="355" y2="400" class="arrow2" />
  <line x1="640" y1="270" x2="355" y2="400" class="arrow2" />
  <line x1="440" y1="350" x2="445" y2="400" class="arrow2" />
  
  <!-- 操作结果连接线 -->
  <line x1="175" y1="430" x2="250" y2="500" class="arrow2" />
  <line x1="355" y1="430" x2="450" y2="500" class="arrow2" />
  <line x1="625" y1="430" x2="250" y2="500" class="arrow2" />
  
  <line x1="250" y1="540" x2="250" y2="580" class="arrow2" />
  <line x1="300" y1="520" x2="400" y2="580" class="arrow2" />
  
  <!-- 标题 -->
  <text x="450" y="20" style="font-family: Arial, sans-serif; font-size: 16px; font-weight: bold; text-anchor: middle;">号码操作决策流程图</text>
</svg>
```

## 5. 业务规则与约束

### 5.1 核心业务规则

1. **单向性原则**：大部分状态转换是单向的，不可逆转
2. **权限控制**：不同操作需要不同的权限级别
3. **数据完整性**：状态转换时必须维护相关数据的一致性
4. **审计追踪**：所有状态变更都必须记录操作日志

### 5.2 特殊约束

#### 5.2.1 解冻操作限制
- 当前实现中，解冻操作固定恢复为"已激活"状态
- 未记录冻结前的原始状态，可能导致状态信息丢失
- **建议**：增加状态记录机制，记录冻结前状态

#### 5.2.2 回收操作特殊性
- 回收操作可以从任意状态执行，是最宽松的操作
- 主要用于异常情况下的强制资源回收
- 会清空所有关联信息（归属组织、ICCID等）

#### 5.2.3 锁定状态处理
- "已锁定"状态在当前实现中未被充分利用
- 只能通过回收操作解除锁定
- **建议**：增加解锁操作，完善锁定机制

### 5.3 数据一致性保证

1. **事务控制**：所有状态变更操作都在事务中执行
2. **乐观锁**：使用更新时间字段防止并发冲突
3. **统计同步**：状态变更时同步更新号段统计信息
4. **日志记录**：记录详细的操作日志用于审计和回溯

## 6. 实现细节

### 6.1 关键实现类

- **NumberResourceServiceImpl**：核心业务逻辑实现
- **NumberStatusEnum**：状态枚举定义
- **OperationTypeEnum**：操作类型枚举定义
- **NumberOperationLogService**：操作日志服务

### 6.2 状态检查机制

```java
// 示例：预留操作的状态检查
if (!NumberStatusEnum.IDLE.getCode().equals(resource.getStatus())) {
    throw new BusinessException("400", "Only idle numbers can be reserved");
}
```

### 6.3 状态更新模式

```java
// 示例：状态更新的标准模式
Integer oldStatus = resource.getStatus();
resource.setStatus(NumberStatusEnum.RESERVED.getCode());
resource.setUpdateTime(new Date());

// 数据库更新
LambdaUpdateWrapper<NumberResource> updateWrapper = new LambdaUpdateWrapper<>();
updateWrapper.eq(NumberResource::getNumber, resource.getNumber())
            .set(NumberResource::getStatus, resource.getStatus())
            .set(NumberResource::getUpdateTime, resource.getUpdateTime());
boolean result = this.update(updateWrapper);

// 记录日志和更新统计
if (result) {
    operationLogService.recordLog(...);
    segmentService.incrementalUpdateStatistics(...);
}
```

## 7. 异常处理

### 7.1 常见异常类型

1. **BusinessException("400", "Number cannot be empty")**：参数验证失败
2. **BusinessException("404", "Number does not exist")**：号码不存在
3. **BusinessException("400", "Only idle numbers can be reserved")**：状态不匹配

### 7.2 异常处理策略

- 所有业务异常都抛出BusinessException
- 异常信息包含错误码和详细描述
- 事务自动回滚，保证数据一致性

## 8. 性能优化

### 8.1 查询优化

- 使用基本查询避免不必要的关联查询
- 分表策略减少单表数据量
- 索引优化提升查询性能

### 8.2 批量操作

- 支持批量状态更新
- 批量统计信息更新
- 减少数据库交互次数

## 9. 监控与审计

### 9.1 操作日志

- 记录所有状态变更操作
- 包含操作前后状态、操作人、操作时间等信息
- 支持按月分区存储

### 9.2 统计信息

- 实时更新号段状态统计
- 支持各种维度的统计查询
- 为运营决策提供数据支持

## 10. 总结

当前号码资源状态管理系统具有以下特点：

**优点：**
1. 状态定义清晰，转换规则明确
2. 完整的事务控制和异常处理
3. 详细的操作日志和审计追踪
4. 良好的性能优化和扩展性

**改进建议：**
1. 增加状态记录机制，特别是冻结前状态记录
2. 完善锁定状态的使用场景和解锁机制
3. 考虑增加更细粒度的权限控制
4. 优化解冻操作的状态恢复逻辑

通过严格的状态管理和操作约束，系统能够确保号码资源的安全、有序管理，满足电信运营商的业务需求。