# 微服务架构演进指南

基于NSRS号卡资源管理系统的微服务化改造方案

## 目录

- [架构演进概述](#架构演进概述)
- [服务拆分策略](#服务拆分策略)
- [技术栈选型](#技术栈选型)
- [服务设计](#服务设计)
- [数据管理](#数据管理)
- [服务间通信](#服务间通信)
- [部署架构](#部署架构)
- [监控与治理](#监控与治理)
- [迁移策略](#迁移策略)
- [最佳实践](#最佳实践)

## 架构演进概述

### 当前单体架构问题

```
当前NSRS单体架构：
┌─────────────────────────────────────┐
│              NSRS Application        │
├─────────────────────────────────────┤
│  User Management                    │
│  IMSI Resource Management           │
│  MSISDN Management                  │
│  SIM Card Management                │
│  Supplier Management                │
│  Billing Management                 │
│  Report & Analytics                 │
└─────────────────────────────────────┘
│
▼
┌─────────────────────────────────────┐
│           MySQL Database            │
└─────────────────────────────────────┘
```

**存在问题：**
- 代码耦合度高，维护困难
- 技术栈单一，无法针对性优化
- 扩展性差，无法独立扩容
- 部署风险高，一个模块问题影响全局
- 团队协作效率低

### 目标微服务架构

```
目标微服务架构：
┌─────────────────────────────────────────────────────────────┐
│                      API Gateway                            │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
┌───────▼──────┐    ┌────────▼─────────┐    ┌──────▼──────┐
│ User Service │    │ Resource Service │    │Auth Service │
└──────────────┘    └──────────────────┘    └─────────────┘
        │                     │                     │
┌───────▼──────┐    ┌────────▼─────────┐    ┌──────▼──────┐
│IMSI Service  │    │ MSISDN Service   │    │Bill Service │
└──────────────┘    └──────────────────┘    └─────────────┘
        │                     │                     │
┌───────▼──────┐    ┌────────▼─────────┐    ┌──────▼──────┐
│ SIM Service  │    │Supplier Service  │    │Report Svc   │
└──────────────┘    └──────────────────┘    └─────────────┘
```

## 服务拆分策略

### 1. 按业务领域拆分（DDD方式）

#### 用户管理服务 (User Service)
```yaml
服务职责:
  - 用户注册、登录、注销
  - 用户信息管理
  - 权限管理
  - 用户会话管理

数据模型:
  - user_info
  - user_role
  - user_permission
  - user_session

技术栈:
  - Spring Boot 2.7+
  - Spring Security
  - JWT
  - Redis (Session)
```

#### IMSI资源服务 (IMSI Resource Service)
```yaml
服务职责:
  - IMSI资源生成
  - IMSI资源分配
  - IMSI生命周期管理
  - IMSI批量操作

数据模型:
  - imsi_resource
  - imsi_group
  - imsi_allocation_log

技术栈:
  - Spring Boot 2.7+
  - MyBatis Plus
  - Redis (缓存)
  - RocketMQ (异步处理)
```

#### MSISDN号码服务 (MSISDN Service)
```yaml
服务职责:
  - 号码资源管理
  - 号码分配策略
  - 号码回收机制
  - 号码池管理

数据模型:
  - msisdn_resource
  - msisdn_pool
  - msisdn_allocation_log

技术栈:
  - Spring Boot 2.7+
  - MyBatis Plus
  - Redis (号码池缓存)
```

#### SIM卡管理服务 (SIM Card Service)
```yaml
服务职责:
  - SIM卡制作管理
  - SIM卡个人化
  - SIM卡发卡激活
  - SIM卡状态管理

数据模型:
  - sim_card
  - sim_card_batch
  - sim_card_operation_log

技术栈:
  - Spring Boot 2.7+
  - MyBatis Plus
  - Redis (状态缓存)
```

#### 供应商管理服务 (Supplier Service)
```yaml
服务职责:
  - 供应商信息管理
  - 供应商资质管理
  - 供应商评估
  - 合同管理

数据模型:
  - supplier_info
  - supplier_contract
  - supplier_evaluation

技术栈:
  - Spring Boot 2.7+
  - MyBatis Plus
```

#### 计费服务 (Billing Service)
```yaml
服务职责:
  - 计费规则管理
  - 费用计算
  - 账单生成
  - 支付处理

数据模型:
  - billing_rule
  - billing_record
  - payment_record

技术栈:
  - Spring Boot 2.7+
  - MyBatis Plus
  - Redis (计费缓存)
  - RocketMQ (异步计费)
```

#### 报表分析服务 (Report Service)
```yaml
服务职责:
  - 数据统计分析
  - 报表生成
  - 数据导出
  - 业务监控

数据模型:
  - report_template
  - report_data
  - analytics_result

技术栈:
  - Spring Boot 2.7+
  - ClickHouse (OLAP)
  - Elasticsearch (搜索)
  - Apache ECharts (图表)
```

### 2. 服务拆分原则

#### 单一职责原则
```java
// 好的服务设计
@RestController
@RequestMapping("/api/v1/imsi")
public class ImsiResourceController {
    
    // 只处理IMSI相关业务
    @PostMapping("/generate")
    public Result<List<ImsiResource>> generateImsi(@RequestBody ImsiGenerateRequest request) {
        return imsiResourceService.generateImsi(request);
    }
    
    @GetMapping("/{imsi}")
    public Result<ImsiResource> getImsiDetail(@PathVariable String imsi) {
        return imsiResourceService.getImsiDetail(imsi);
    }
}

// 避免的设计
@RestController
public class ResourceController {
    // 不要在一个服务中处理多种资源
    @PostMapping("/imsi/generate")
    @PostMapping("/msisdn/generate")
    @PostMapping("/sim/generate")
    // ...
}
```

#### 数据独立原则
```yaml
# 每个服务独立的数据库
services:
  user-service:
    database: nsrs_user
    tables:
      - user_info
      - user_role
      - user_permission
  
  imsi-service:
    database: nsrs_imsi
    tables:
      - imsi_resource
      - imsi_group
      - imsi_allocation_log
  
  msisdn-service:
    database: nsrs_msisdn
    tables:
      - msisdn_resource
      - msisdn_pool
```

## 技术栈选型

### 1. Spring Cloud Alibaba技术栈

#### 依赖管理 (pom.xml)
```xml
<properties>
    <spring-boot.version>2.7.8</spring-boot.version>
    <spring-cloud.version>2021.0.5</spring-cloud.version>
    <spring-cloud-alibaba.version>2021.0.5.0</spring-cloud-alibaba.version>
</properties>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-dependencies</artifactId>
            <version>${spring-boot.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring-cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>${spring-cloud-alibaba.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>

<dependencies>
    <!-- 服务注册发现 -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    
    <!-- 配置中心 -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
    
    <!-- 网关 -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    
    <!-- 负载均衡 -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-loadbalancer</artifactId>
    </dependency>
    
    <!-- 熔断限流 -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
    </dependency>
    
    <!-- 分布式事务 -->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
    </dependency>
    
    <!-- 消息队列 -->
    <dependency>
        <groupId>org.apache.rocketmq</groupId>
        <artifactId>rocketmq-spring-boot-starter</artifactId>
        <version>2.2.3</version>
    </dependency>
</dependencies>
```

### 2. 服务配置示例

#### Nacos配置 (application.yml)
```yaml
spring:
  application:
    name: nsrs-imsi-service
  profiles:
    active: dev
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
        namespace: nsrs-dev
        group: NSRS_GROUP
        metadata:
          version: 1.0.0
          region: beijing
      config:
        server-addr: 127.0.0.1:8848
        namespace: nsrs-dev
        group: NSRS_GROUP
        file-extension: yml
        shared-configs:
          - data-id: common-config.yml
            group: NSRS_GROUP
            refresh: true

server:
  port: 8081

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
```

#### 网关配置 (Gateway)
```yaml
spring:
  application:
    name: nsrs-gateway
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        # IMSI服务路由
        - id: imsi-service
          uri: lb://nsrs-imsi-service
          predicates:
            - Path=/api/v1/imsi/**
          filters:
            - StripPrefix=1
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
        
        # 用户服务路由
        - id: user-service
          uri: lb://nsrs-user-service
          predicates:
            - Path=/api/v1/user/**
          filters:
            - StripPrefix=1
        
        # MSISDN服务路由
        - id: msisdn-service
          uri: lb://nsrs-msisdn-service
          predicates:
            - Path=/api/v1/msisdn/**
          filters:
            - StripPrefix=1

      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: true

server:
  port: 8080
```

## 服务设计

### 1. 服务接口设计

#### IMSI资源服务接口
```java
@RestController
@RequestMapping("/api/v1/imsi")
@Validated
public class ImsiResourceController {
    
    @Autowired
    private ImsiResourceService imsiResourceService;
    
    /**
     * 生成IMSI资源
     */
    @PostMapping("/generate")
    public Result<List<ImsiResourceDTO>> generateImsi(
            @Valid @RequestBody ImsiGenerateRequest request) {
        List<ImsiResourceDTO> result = imsiResourceService.generateImsi(request);
        return Result.success(result);
    }
    
    /**
     * 分页查询IMSI资源
     */
    @GetMapping("/page")
    public Result<PageResult<ImsiResourceDTO>> pageImsiResource(
            @Valid ImsiResourceQuery query) {
        PageResult<ImsiResourceDTO> result = imsiResourceService.pageImsiResource(query);
        return Result.success(result);
    }
    
    /**
     * 根据IMSI获取详情
     */
    @GetMapping("/{imsi}")
    public Result<ImsiResourceDTO> getImsiDetail(
            @PathVariable @Pattern(regexp = "^\\d{15}$", message = "IMSI format invalid") String imsi) {
        ImsiResourceDTO result = imsiResourceService.getImsiDetail(imsi);
        return Result.success(result);
    }
    
    /**
     * 批量分配IMSI
     */
    @PostMapping("/allocate")
    public Result<List<ImsiResourceDTO>> allocateImsi(
            @Valid @RequestBody ImsiAllocateRequest request) {
        List<ImsiResourceDTO> result = imsiResourceService.allocateImsi(request);
        return Result.success(result);
    }
    
    /**
     * 更新IMSI状态
     */
    @PutMapping("/{imsi}/status")
    public Result<Boolean> updateImsiStatus(
            @PathVariable String imsi,
            @Valid @RequestBody ImsiStatusUpdateRequest request) {
        Boolean result = imsiResourceService.updateImsiStatus(imsi, request.getStatus());
        return Result.success(result);
    }
}
```

#### 服务间调用接口 (Feign Client)
```java
@FeignClient(name = "nsrs-user-service", path = "/api/v1/user")
public interface UserServiceClient {
    
    @GetMapping("/{userId}")
    Result<UserDTO> getUserById(@PathVariable("userId") Long userId);
    
    @PostMapping("/validate")
    Result<Boolean> validateUser(@RequestBody UserValidateRequest request);
}

@FeignClient(name = "nsrs-supplier-service", path = "/api/v1/supplier")
public interface SupplierServiceClient {
    
    @GetMapping("/{supplierId}")
    Result<SupplierDTO> getSupplierById(@PathVariable("supplierId") Long supplierId);
    
    @GetMapping("/{supplierId}/available")
    Result<Boolean> isSupplierAvailable(@PathVariable("supplierId") Long supplierId);
}
```

### 2. 服务实现示例

#### IMSI资源服务实现
```java
@Service
@Transactional
public class ImsiResourceServiceImpl implements ImsiResourceService {
    
    @Autowired
    private ImsiResourceMapper imsiResourceMapper;
    
    @Autowired
    private UserServiceClient userServiceClient;
    
    @Autowired
    private SupplierServiceClient supplierServiceClient;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    @Override
    public List<ImsiResourceDTO> generateImsi(ImsiGenerateRequest request) {
        // 1. 参数校验
        validateGenerateRequest(request);
        
        // 2. 检查供应商状态
        Result<Boolean> supplierResult = supplierServiceClient.isSupplierAvailable(request.getSupplierId());
        if (!supplierResult.isSuccess() || !supplierResult.getData()) {
            throw new BusinessException("Supplier is not available");
        }
        
        // 3. 生成IMSI资源
        List<ImsiResource> imsiList = doGenerateImsi(request);
        
        // 4. 批量保存
        imsiResourceMapper.batchInsert(imsiList);
        
        // 5. 发送异步消息
        ImsiGeneratedEvent event = new ImsiGeneratedEvent();
        event.setImsiList(imsiList.stream().map(ImsiResource::getImsi).collect(Collectors.toList()));
        event.setSupplierId(request.getSupplierId());
        event.setGenerateTime(new Date());
        
        rocketMQTemplate.asyncSend("imsi-generated-topic", event, new SendCallback() {
            @Override
            public void onSuccess(SendResult sendResult) {
                log.info("IMSI generated event sent successfully: {}", sendResult.getMsgId());
            }
            
            @Override
            public void onException(Throwable e) {
                log.error("Failed to send IMSI generated event", e);
            }
        });
        
        // 6. 更新缓存
        updateImsiCache(imsiList);
        
        return imsiList.stream().map(this::convertToDTO).collect(Collectors.toList());
    }
    
    @Override
    @Cacheable(value = "imsi:detail", key = "#imsi")
    public ImsiResourceDTO getImsiDetail(String imsi) {
        ImsiResource imsiResource = imsiResourceMapper.selectByImsi(imsi);
        if (imsiResource == null) {
            throw new BusinessException("IMSI not found: " + imsi);
        }
        return convertToDTO(imsiResource);
    }
    
    private void updateImsiCache(List<ImsiResource> imsiList) {
        for (ImsiResource imsi : imsiList) {
            String cacheKey = "imsi:detail:" + imsi.getImsi();
            redisTemplate.opsForValue().set(cacheKey, convertToDTO(imsi), Duration.ofHours(1));
        }
    }
    
    private ImsiResourceDTO convertToDTO(ImsiResource imsiResource) {
        ImsiResourceDTO dto = new ImsiResourceDTO();
        BeanUtils.copyProperties(imsiResource, dto);
        return dto;
    }
}
```

## 数据管理

### 1. 数据库拆分策略

#### 按服务拆分数据库
```sql
-- 用户服务数据库
CREATE DATABASE nsrs_user;
USE nsrs_user;

CREATE TABLE user_info (
    user_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(20),
    status TINYINT DEFAULT 1,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- IMSI服务数据库
CREATE DATABASE nsrs_imsi;
USE nsrs_imsi;

CREATE TABLE imsi_resource (
    imsi_id BIGINT PRIMARY KEY,
    imsi VARCHAR(15) NOT NULL UNIQUE,
    imsi_type TINYINT NOT NULL,
    group_id BIGINT,
    supplier_id BIGINT,
    password VARCHAR(8),
    bill_id VARCHAR(50),
    status TINYINT DEFAULT 1,
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    create_user_id BIGINT,
    update_user_id BIGINT,
    INDEX idx_imsi (imsi),
    INDEX idx_group_id (group_id),
    INDEX idx_supplier_id (supplier_id),
    INDEX idx_status (status)
);
```

### 2. 数据一致性处理

#### 分布式事务配置 (Seata)
```yaml
# Seata配置
seata:
  enabled: true
  application-id: nsrs-imsi-service
  tx-service-group: nsrs-tx-group
  service:
    vgroup-mapping:
      nsrs-tx-group: default
    grouplist:
      default: 127.0.0.1:8091
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      namespace: seata
      group: SEATA_GROUP
      data-id: seataServer.properties
  registry:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      namespace: seata
      group: SEATA_GROUP
      application: seata-server
```

#### 分布式事务使用示例
```java
@Service
public class ImsiAllocationService {
    
    @Autowired
    private ImsiResourceService imsiResourceService;
    
    @Autowired
    private UserServiceClient userServiceClient;
    
    @Autowired
    private BillingServiceClient billingServiceClient;
    
    @GlobalTransactional(rollbackFor = Exception.class)
    public void allocateImsiWithBilling(ImsiAllocateRequest request) {
        try {
            // 1. 分配IMSI资源
            List<ImsiResourceDTO> imsiList = imsiResourceService.allocateImsi(request);
            
            // 2. 创建计费记录
            BillingCreateRequest billingRequest = new BillingCreateRequest();
            billingRequest.setUserId(request.getUserId());
            billingRequest.setImsiList(imsiList.stream().map(ImsiResourceDTO::getImsi).collect(Collectors.toList()));
            billingRequest.setAmount(calculateAmount(imsiList));
            
            Result<BillingDTO> billingResult = billingServiceClient.createBilling(billingRequest);
            if (!billingResult.isSuccess()) {
                throw new BusinessException("Failed to create billing record");
            }
            
            // 3. 更新用户配额
            UserQuotaUpdateRequest quotaRequest = new UserQuotaUpdateRequest();
            quotaRequest.setUserId(request.getUserId());
            quotaRequest.setQuotaChange(-imsiList.size());
            
            Result<Boolean> quotaResult = userServiceClient.updateQuota(quotaRequest);
            if (!quotaResult.isSuccess() || !quotaResult.getData()) {
                throw new BusinessException("Failed to update user quota");
            }
            
        } catch (Exception e) {
            log.error("Failed to allocate IMSI with billing", e);
            throw e;
        }
    }
}
```

## 服务间通信

### 1. 同步通信 (Feign)

#### Feign配置
```yaml
feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 10000
        loggerLevel: basic
      nsrs-user-service:
        connectTimeout: 3000
        readTimeout: 5000
  hystrix:
    enabled: true
  compression:
    request:
      enabled: true
    response:
      enabled: true
```

#### 熔断降级配置
```java
@Component
public class UserServiceClientFallback implements UserServiceClient {
    
    @Override
    public Result<UserDTO> getUserById(Long userId) {
        log.warn("User service is unavailable, using fallback for userId: {}", userId);
        UserDTO fallbackUser = new UserDTO();
        fallbackUser.setUserId(userId);
        fallbackUser.setUsername("Unknown User");
        return Result.success(fallbackUser);
    }
    
    @Override
    public Result<Boolean> validateUser(UserValidateRequest request) {
        log.warn("User service is unavailable, using fallback for user validation");
        return Result.success(false);
    }
}
```

### 2. 异步通信 (RocketMQ)

#### 消息生产者
```java
@Component
public class ImsiEventProducer {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    public void sendImsiGeneratedEvent(ImsiGeneratedEvent event) {
        rocketMQTemplate.asyncSend("imsi-generated-topic", event, new SendCallback() {
            @Override
            public void onSuccess(SendResult sendResult) {
                log.info("IMSI generated event sent: {}", sendResult.getMsgId());
            }
            
            @Override
            public void onException(Throwable e) {
                log.error("Failed to send IMSI generated event", e);
            }
        });
    }
    
    public void sendImsiStatusChangedEvent(ImsiStatusChangedEvent event) {
        rocketMQTemplate.convertAndSend("imsi-status-changed-topic", event);
    }
}
```

#### 消息消费者
```java
@Component
@RocketMQMessageListener(
    topic = "imsi-generated-topic",
    consumerGroup = "billing-consumer-group"
)
public class ImsiGeneratedEventConsumer implements RocketMQListener<ImsiGeneratedEvent> {
    
    @Autowired
    private BillingService billingService;
    
    @Override
    public void onMessage(ImsiGeneratedEvent event) {
        try {
            log.info("Received IMSI generated event: {}", event);
            
            // 创建预计费记录
            BillingPreCreateRequest request = new BillingPreCreateRequest();
            request.setImsiList(event.getImsiList());
            request.setSupplierId(event.getSupplierId());
            request.setGenerateTime(event.getGenerateTime());
            
            billingService.preCreateBilling(request);
            
        } catch (Exception e) {
            log.error("Failed to process IMSI generated event", e);
            throw e; // 重新抛出异常，触发重试
        }
    }
}
```

## 部署架构

### 1. Docker容器化

#### Dockerfile示例
```dockerfile
# IMSI服务Dockerfile
FROM openjdk:8-jre-alpine

VOLUME /tmp

ADD target/nsrs-imsi-service-1.0.0.jar app.jar

EXPOSE 8081

ENTRYPOINT ["java", "-Djava.security.egd=file:/dev/./urandom", "-jar", "/app.jar"]
```

#### Docker Compose配置
```yaml
version: '3.8'

services:
  # Nacos
  nacos:
    image: nacos/nacos-server:v2.2.0
    container_name: nacos
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=nacos
      - MYSQL_SERVICE_PASSWORD=nacos
    ports:
      - "8848:8848"
    depends_on:
      - mysql
    networks:
      - nsrs-network

  # MySQL
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_DATABASE=nacos
      - MYSQL_USER=nacos
      - MYSQL_PASSWORD=nacos
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - nsrs-network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - nsrs-network

  # RocketMQ NameServer
  rocketmq-nameserver:
    image: apache/rocketmq:4.9.4
    container_name: rocketmq-nameserver
    ports:
      - "9876:9876"
    environment:
      - JAVA_OPT_EXT=-server -Xms512m -Xmx512m
    command: sh mqnamesrv
    networks:
      - nsrs-network

  # RocketMQ Broker
  rocketmq-broker:
    image: apache/rocketmq:4.9.4
    container_name: rocketmq-broker
    ports:
      - "10909:10909"
      - "10911:10911"
    environment:
      - NAMESRV_ADDR=rocketmq-nameserver:9876
      - JAVA_OPT_EXT=-server -Xms512m -Xmx512m
    command: sh mqbroker -c /opt/rocketmq-4.9.4/conf/broker.conf
    depends_on:
      - rocketmq-nameserver
    networks:
      - nsrs-network

  # Gateway
  nsrs-gateway:
    build:
      context: ./nsrs-gateway
      dockerfile: Dockerfile
    container_name: nsrs-gateway
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
    depends_on:
      - nacos
    networks:
      - nsrs-network

  # User Service
  nsrs-user-service:
    build:
      context: ./nsrs-user-service
      dockerfile: Dockerfile
    container_name: nsrs-user-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - nsrs-network

  # IMSI Service
  nsrs-imsi-service:
    build:
      context: ./nsrs-imsi-service
      dockerfile: Dockerfile
    container_name: nsrs-imsi-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
      - ROCKETMQ_NAMESERVER=rocketmq-nameserver:9876
    depends_on:
      - nacos
      - mysql
      - redis
      - rocketmq-nameserver
    networks:
      - nsrs-network

volumes:
  mysql-data:

networks:
  nsrs-network:
    driver: bridge
```

### 2. Kubernetes部署

#### 服务部署配置
```yaml
# imsi-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nsrs-imsi-service
  namespace: nsrs
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nsrs-imsi-service
  template:
    metadata:
      labels:
        app: nsrs-imsi-service
    spec:
      containers:
      - name: nsrs-imsi-service
        image: nsrs/imsi-service:1.0.0
        ports:
        - containerPort: 8081
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        - name: NACOS_SERVER_ADDR
          value: "nacos-service:8848"
        - name: MYSQL_HOST
          value: "mysql-service"
        - name: REDIS_HOST
          value: "redis-service"
        resources:
          requests:
            memory: "512Mi"
            cpu: "250m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10

---
apiVersion: v1
kind: Service
metadata:
  name: nsrs-imsi-service
  namespace: nsrs
spec:
  selector:
    app: nsrs-imsi-service
  ports:
  - protocol: TCP
    port: 8081
    targetPort: 8081
  type: ClusterIP
```

## 监控与治理

### 1. 服务监控

#### Prometheus配置
```yaml
# prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'nsrs-services'
    metrics_path: '/actuator/prometheus'
    static_configs:
      - targets:
        - 'nsrs-gateway:8080'
        - 'nsrs-user-service:8082'
        - 'nsrs-imsi-service:8081'
        - 'nsrs-msisdn-service:8083'
        - 'nsrs-billing-service:8084'
    scrape_interval: 10s
```

#### Grafana仪表板配置
```json
{
  "dashboard": {
    "title": "NSRS微服务监控",
    "panels": [
      {
        "title": "服务QPS",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{service}}"
          }
        ]
      },
      {
        "title": "服务响应时间",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          }
        ]
      },
      {
        "title": "错误率",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])",
            "legendFormat": "Error Rate"
          }
        ]
      }
    ]
  }
}
```

### 2. 链路追踪

#### SkyWalking配置
```yaml
# application.yml
spring:
  application:
    name: nsrs-imsi-service

# SkyWalking配置
skywalking:
  agent:
    service_name: nsrs-imsi-service
    collector:
      backend_service: skywalking-oap:11800
    logging:
      level: INFO
```

#### 自定义链路追踪
```java
@Component
public class TraceUtils {
    
    public static void addTag(String key, String value) {
        ActiveSpan.tag(key, value);
    }
    
    public static void addLog(String message) {
        ActiveSpan.info(message);
    }
    
    public static void addError(Throwable throwable) {
        ActiveSpan.error(throwable);
    }
}

@Service
public class ImsiResourceServiceImpl {
    
    public List<ImsiResourceDTO> generateImsi(ImsiGenerateRequest request) {
        TraceUtils.addTag("operation", "generateImsi");
        TraceUtils.addTag("count", String.valueOf(request.getCount()));
        TraceUtils.addTag("supplierId", String.valueOf(request.getSupplierId()));
        
        try {
            List<ImsiResourceDTO> result = doGenerateImsi(request);
            TraceUtils.addTag("generated.count", String.valueOf(result.size()));
            return result;
        } catch (Exception e) {
            TraceUtils.addError(e);
            throw e;
        }
    }
}
```

## 迁移策略

### 1. 渐进式迁移

#### 阶段一：基础设施准备
```bash
# 1. 部署Nacos
docker run -d --name nacos \
  -p 8848:8848 \
  -e MODE=standalone \
  nacos/nacos-server:v2.2.0

# 2. 部署Redis
docker run -d --name redis \
  -p 6379:6379 \
  redis:7-alpine

# 3. 部署RocketMQ
docker run -d --name rocketmq-nameserver \
  -p 9876:9876 \
  apache/rocketmq:4.9.4 \
  sh mqnamesrv
```

#### 阶段二：服务拆分
```java
// 1. 先拆分独立性强的服务
// 用户服务 -> 供应商服务 -> 报表服务

// 2. 再拆分核心业务服务
// IMSI服务 -> MSISDN服务 -> SIM卡服务

// 3. 最后拆分依赖性强的服务
// 计费服务（依赖其他所有服务）
```

#### 阶段三：数据迁移
```sql
-- 数据迁移脚本
-- 1. 创建新的服务数据库
CREATE DATABASE nsrs_user;
CREATE DATABASE nsrs_imsi;
CREATE DATABASE nsrs_msisdn;

-- 2. 迁移数据
INSERT INTO nsrs_user.user_info 
SELECT * FROM nsrs.user_info;

INSERT INTO nsrs_imsi.imsi_resource 
SELECT * FROM nsrs.imsi_resource;

-- 3. 验证数据一致性
SELECT COUNT(*) FROM nsrs.user_info;
SELECT COUNT(*) FROM nsrs_user.user_info;
```

### 2. 灰度发布

#### 网关路由配置
```yaml
spring:
  cloud:
    gateway:
      routes:
        # 灰度路由：10%流量到新服务
        - id: imsi-service-canary
          uri: lb://nsrs-imsi-service-v2
          predicates:
            - Path=/api/v1/imsi/**
            - Weight=imsi-group, 10
          filters:
            - StripPrefix=1
        
        # 主路由：90%流量到旧服务
        - id: imsi-service-main
          uri: lb://nsrs-imsi-service-v1
          predicates:
            - Path=/api/v1/imsi/**
            - Weight=imsi-group, 90
          filters:
            - StripPrefix=1
```

## 最佳实践

### 1. 服务设计原则

- **单一职责**：每个服务只负责一个业务领域
- **数据独立**：服务间不共享数据库
- **接口稳定**：向后兼容的API设计
- **故障隔离**：服务故障不影响其他服务
- **可观测性**：完善的监控、日志、链路追踪

### 2. 开发规范

```java
// 统一的响应格式
public class Result<T> {
    private int code;
    private String message;
    private T data;
    private long timestamp;
    
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("Success");
        result.setData(data);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
    
    public static <T> Result<T> error(int code, String message) {
        Result<T> result = new Result<>();
        result.setCode(code);
        result.setMessage(message);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
}

// 统一的异常处理
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        log.error("Business exception: {}", e.getMessage(), e);
        return Result.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("System exception: {}", e.getMessage(), e);
        return Result.error(500, "System error");
    }
}
```

### 3. 性能优化

```java
// 异步处理
@Async("taskExecutor")
public CompletableFuture<List<ImsiResourceDTO>> generateImsiAsync(ImsiGenerateRequest request) {
    List<ImsiResourceDTO> result = generateImsi(request);
    return CompletableFuture.completedFuture(result);
}

// 批量操作
@Transactional
public void batchUpdateImsiStatus(List<String> imsiList, Integer status) {
    // 分批处理，避免长事务
    int batchSize = 1000;
    for (int i = 0; i < imsiList.size(); i += batchSize) {
        int endIndex = Math.min(i + batchSize, imsiList.size());
        List<String> batch = imsiList.subList(i, endIndex);
        imsiResourceMapper.batchUpdateStatus(batch, status);
    }
}

// 缓存优化
@Cacheable(value = "imsi:group", key = "#groupId", unless = "#result == null")
public List<ImsiResourceDTO> getImsiByGroupId(Long groupId) {
    return imsiResourceMapper.selectByGroupId(groupId)
        .stream()
        .map(this::convertToDTO)
        .collect(Collectors.toList());
}
```

通过以上微服务架构演进方案，NSRS系统可以逐步从单体架构转向微服务架构，提升系统的可扩展性、可维护性和可靠性。