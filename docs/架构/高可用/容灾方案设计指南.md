# å®¹ç¾æ–¹æ¡ˆè®¾è®¡æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäºNSRSå·å¡èµ„æºç®¡ç†ç³»ç»Ÿï¼Œè®¾è®¡å®Œæ•´çš„å®¹ç¾æ–¹æ¡ˆï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å„ç§ç¾éš¾åœºæ™¯ä¸‹èƒ½å¤Ÿå¿«é€Ÿæ¢å¤æœåŠ¡ï¼Œä¿éšœä¸šåŠ¡è¿ç»­æ€§ã€‚

## å®¹ç¾æ¶æ„ç›®æ ‡

- **RTO (Recovery Time Objective)**: ç³»ç»Ÿæ¢å¤æ—¶é—´ç›®æ ‡ â‰¤ 30åˆ†é’Ÿ
- **RPO (Recovery Point Objective)**: æ•°æ®æ¢å¤ç‚¹ç›®æ ‡ â‰¤ 5åˆ†é’Ÿ
- **å¯ç”¨æ€§ç›®æ ‡**: 99.99% (å¹´åœæœºæ—¶é—´ â‰¤ 52.56åˆ†é’Ÿ)
- **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿ä¸»å¤‡æ•°æ®ä¸­å¿ƒæ•°æ®ä¸€è‡´æ€§

## å®¹ç¾æ¶æ„è®¾è®¡

### 1. åŒæ´»æ•°æ®ä¸­å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¸»æ•°æ®ä¸­å¿ƒ     â”‚    â”‚   å¤‡æ•°æ®ä¸­å¿ƒ     â”‚
â”‚   (Beijing)     â”‚    â”‚   (Shanghai)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Load Balancer   â”‚â—„â”€â”€â–ºâ”‚ Load Balancer   â”‚
â”‚ Application     â”‚    â”‚ Application     â”‚
â”‚ Database Master â”‚â—„â”€â”€â–ºâ”‚ Database Slave  â”‚
â”‚ Redis Master    â”‚â—„â”€â”€â–ºâ”‚ Redis Slave     â”‚
â”‚ File Storage    â”‚â—„â”€â”€â–ºâ”‚ File Storage    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              ä¸“çº¿/VPNè¿æ¥
```

### 2. å®¹ç¾çº§åˆ«å®šä¹‰

#### 2.1 åŒåŸå®¹ç¾ (Tier 1)
- **è·ç¦»**: ä¸»å¤‡ä¸­å¿ƒè·ç¦» < 100km
- **ç½‘ç»œ**: ä¸“çº¿è¿æ¥ï¼Œå»¶è¿Ÿ < 5ms
- **æ•°æ®åŒæ­¥**: å®æ—¶åŒæ­¥
- **åˆ‡æ¢æ—¶é—´**: < 5åˆ†é’Ÿ

#### 2.2 å¼‚åœ°å®¹ç¾ (Tier 2)
- **è·ç¦»**: ä¸»å¤‡ä¸­å¿ƒè·ç¦» > 100km
- **ç½‘ç»œ**: ä¸“çº¿/VPNè¿æ¥ï¼Œå»¶è¿Ÿ < 50ms
- **æ•°æ®åŒæ­¥**: å‡†å®æ—¶åŒæ­¥
- **åˆ‡æ¢æ—¶é—´**: < 30åˆ†é’Ÿ

#### 2.3 äº‘ç«¯å®¹ç¾ (Tier 3)
- **éƒ¨ç½²**: æ··åˆäº‘/å¤šäº‘æ¶æ„
- **ç½‘ç»œ**: äº’è”ç½‘è¿æ¥
- **æ•°æ®åŒæ­¥**: å®šæ—¶åŒæ­¥
- **åˆ‡æ¢æ—¶é—´**: < 2å°æ—¶

## æ•°æ®åº“å®¹ç¾æ–¹æ¡ˆ

### 1. MySQLä¸»ä»å¤åˆ¶é…ç½®

#### ä¸»åº“é…ç½® (my.cnf)
```ini
# ä¸»åº“é…ç½®
[mysqld]
server-id = 1
log-bin = mysql-bin
binlog-format = ROW
binlog-do-db = nsrs_sim_resource_0,nsrs_sim_resource_1,nsrs_sim_resource_2,nsrs_sim_resource_3
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1

# åŠåŒæ­¥å¤åˆ¶
plugin-load = "rpl_semi_sync_master=semisync_master.so"
rpl_semi_sync_master_enabled = 1
rpl_semi_sync_master_timeout = 1000
```

#### ä»åº“é…ç½® (my.cnf)
```ini
# ä»åº“é…ç½®
[mysqld]
server-id = 2
relay-log = relay-bin
log-slave-updates = 1
read_only = 1
super_read_only = 1

# åŠåŒæ­¥å¤åˆ¶
plugin-load = "rpl_semi_sync_slave=semisync_slave.so"
rpl_semi_sync_slave_enabled = 1
```

#### ä¸»ä»å¤åˆ¶ç›‘æ§è„šæœ¬
```bash
#!/bin/bash
# mysql_replication_monitor.sh

DB_HOST="10.1.7.11"
DB_USER="monitor"
DB_PASS="monitor_password"
LOG_FILE="/var/log/mysql_replication.log"
ALERT_EMAIL="admin@nsrs.com"
MAX_DELAY=10  # æœ€å¤§å»¶è¿Ÿç§’æ•°

# æ£€æŸ¥å¤åˆ¶çŠ¶æ€
check_replication() {
    local result=$(mysql -h"$DB_HOST" -u"$DB_USER" -p"$DB_PASS" \
        -e "SHOW SLAVE STATUS\G" | grep -E "Slave_IO_Running|Slave_SQL_Running|Seconds_Behind_Master")
    
    local io_running=$(echo "$result" | grep "Slave_IO_Running" | awk '{print $2}')
    local sql_running=$(echo "$result" | grep "Slave_SQL_Running" | awk '{print $2}')
    local delay=$(echo "$result" | grep "Seconds_Behind_Master" | awk '{print $2}')
    
    echo "$(date): IO_Running=$io_running, SQL_Running=$sql_running, Delay=$delay" >> "$LOG_FILE"
    
    # æ£€æŸ¥å¤åˆ¶æ˜¯å¦æ­£å¸¸
    if [ "$io_running" != "Yes" ] || [ "$sql_running" != "Yes" ]; then
        send_alert "MySQL replication stopped: IO=$io_running, SQL=$sql_running"
        return 1
    fi
    
    # æ£€æŸ¥å»¶è¿Ÿ
    if [ "$delay" != "NULL" ] && [ "$delay" -gt "$MAX_DELAY" ]; then
        send_alert "MySQL replication delay too high: ${delay}s"
        return 1
    fi
    
    return 0
}

# å‘é€å‘Šè­¦
send_alert() {
    local message="$1"
    echo "ALERT: $message" >> "$LOG_FILE"
    echo "$message" | mail -s "MySQL Replication Alert" "$ALERT_EMAIL"
    
    # å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    curl -X POST "http://monitoring.nsrs.com/api/alerts" \
        -H "Content-Type: application/json" \
        -d "{
            \"level\": \"info\",
            \"message\": \"$message\",
            \"service\": \"network-$line_name\"
        }"
    
    log "Recovery alert sent for $line_name line"
}

# å‘é€ä¸¥é‡å‘Šè­¦
send_critical_alert() {
    local message="$1"
    
    # å‘é€é‚®ä»¶
    echo "CRITICAL: $message" | mail -s "CRITICAL Network Alert" "admin@nsrs.com"
    
    # å‘é€çŸ­ä¿¡
    curl -X POST "https://sms.api.com/send" \
        -d "phone=13800138000&message=CRITICAL: $message"
    
    log "Critical alert sent: $message"
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    log "Starting network monitoring"
    
    while true; do
        check_line_status "$TELECOM_GW" "telecom"
        check_line_status "$UNICOM_GW" "unicom"
        check_line_status "$MOBILE_GW" "mobile"
        
        sleep 60  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    done
}

# æ‰§è¡Œä¸»ç¨‹åº
main "$@"
```

## å®¹ç¾æ¼”ç»ƒæ–¹æ¡ˆ

### 1. æ¼”ç»ƒè®¡åˆ’

#### æœˆåº¦æ¼”ç»ƒè®¡åˆ’
```bash
#!/bin/bash
# disaster_drill.sh - å®¹ç¾æ¼”ç»ƒè„šæœ¬

DRILL_TYPE="$1"  # database, redis, application, network, full
LOG_FILE="/var/log/disaster_drill.log"
REPORT_FILE="/var/log/drill_report_$(date +%Y%m%d_%H%M%S).txt"

# æ¼”ç»ƒå¼€å§‹æ—¶é—´
START_TIME=$(date +%s)

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# æ•°æ®åº“æ•…éšœæ¼”ç»ƒ
database_drill() {
    log "Starting database failover drill"
    
    # æ¨¡æ‹Ÿä¸»åº“æ•…éšœ
    log "Simulating primary database failure"
    kubectl patch service mysql-primary -p '{"spec":{"selector":{"app":"mysql-fake"}}}'
    
    # ç­‰å¾…æ•…éšœæ£€æµ‹
    sleep 30
    
    # æ£€æŸ¥åº”ç”¨æ˜¯å¦è‡ªåŠ¨åˆ‡æ¢åˆ°ä»åº“
    local app_status=$(kubectl get pods -l app=nsrs-application -o jsonpath='{.items[*].status.phase}')
    if [[ "$app_status" == *"Running"* ]]; then
        log "âœ… Application remained running during database failover"
    else
        log "âŒ Application failed during database failover"
    fi
    
    # æ¢å¤ä¸»åº“
    log "Restoring primary database"
    kubectl patch service mysql-primary -p '{"spec":{"selector":{"app":"mysql"}}}'
    
    sleep 30
    log "Database failover drill completed"
}

# Redisæ•…éšœæ¼”ç»ƒ
redis_drill() {
    log "Starting Redis failover drill"
    
    # æ¨¡æ‹ŸRedisä¸»èŠ‚ç‚¹æ•…éšœ
    log "Simulating Redis master failure"
    kubectl delete pod redis-master-0
    
    # ç­‰å¾…Sentinelæ£€æµ‹å¹¶åˆ‡æ¢
    sleep 60
    
    # æ£€æŸ¥åº”ç”¨ç¼“å­˜åŠŸèƒ½
    local cache_test=$(curl -s http://nsrs.example.com/api/cache/test)
    if [[ "$cache_test" == *"success"* ]]; then
        log "âœ… Cache functionality working after Redis failover"
    else
        log "âŒ Cache functionality failed after Redis failover"
    fi
    
    log "Redis failover drill completed"
}

# åº”ç”¨æ•…éšœæ¼”ç»ƒ
application_drill() {
    log "Starting application failover drill"
    
    # æ¨¡æ‹Ÿä¸»é›†ç¾¤æ•…éšœ
    log "Simulating primary cluster failure"
    kubectl scale deployment nsrs-application --replicas=0 --context=primary-cluster
    
    # ç­‰å¾…æµé‡åˆ‡æ¢
    sleep 120
    
    # æ£€æŸ¥å¤‡é›†ç¾¤æ˜¯å¦æ¥ç®¡æµé‡
    local health_check=$(curl -s -o /dev/null -w "%{http_code}" https://nsrs.example.com/actuator/health)
    if [ "$health_check" = "200" ]; then
        log "âœ… Backup cluster successfully took over traffic"
    else
        log "âŒ Backup cluster failed to take over traffic"
    fi
    
    # æ¢å¤ä¸»é›†ç¾¤
    log "Restoring primary cluster"
    kubectl scale deployment nsrs-application --replicas=6 --context=primary-cluster
    
    sleep 180
    log "Application failover drill completed"
}

# ç½‘ç»œæ•…éšœæ¼”ç»ƒ
network_drill() {
    log "Starting network failover drill"
    
    # æ¨¡æ‹Ÿç”µä¿¡çº¿è·¯æ•…éšœ
    log "Simulating telecom line failure"
    iptables -A OUTPUT -d 202.96.128.1 -j DROP
    
    # ç­‰å¾…è·¯ç”±åˆ‡æ¢
    sleep 60
    
    # æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
    if ping -c 3 8.8.8.8 >/dev/null 2>&1; then
        log "âœ… Network connectivity maintained after line failure"
    else
        log "âŒ Network connectivity lost after line failure"
    fi
    
    # æ¢å¤ç½‘ç»œ
    log "Restoring telecom line"
    iptables -D OUTPUT -d 202.96.128.1 -j DROP
    
    sleep 30
    log "Network failover drill completed"
}

# å…¨é¢å®¹ç¾æ¼”ç»ƒ
full_drill() {
    log "Starting full disaster recovery drill"
    
    database_drill
    redis_drill
    application_drill
    network_drill
    
    log "Full disaster recovery drill completed"
}

# ç”Ÿæˆæ¼”ç»ƒæŠ¥å‘Š
generate_report() {
    local end_time=$(date +%s)
    local duration=$((end_time - START_TIME))
    
    cat > "$REPORT_FILE" << EOF
# å®¹ç¾æ¼”ç»ƒæŠ¥å‘Š

## æ¼”ç»ƒä¿¡æ¯
- æ¼”ç»ƒç±»å‹: $DRILL_TYPE
- å¼€å§‹æ—¶é—´: $(date -d @$START_TIME)
- ç»“æŸæ—¶é—´: $(date -d @$end_time)
- æ¼”ç»ƒæ—¶é•¿: ${duration}ç§’

## æ¼”ç»ƒç»“æœ
$(grep -E "âœ…|âŒ" "$LOG_FILE" | tail -20)

## è¯¦ç»†æ—¥å¿—
$(tail -100 "$LOG_FILE")

## æ”¹è¿›å»ºè®®
- æ£€æŸ¥æ•…éšœæ£€æµ‹æ—¶é—´æ˜¯å¦ç¬¦åˆRTOè¦æ±‚
- éªŒè¯æ•°æ®ä¸€è‡´æ€§
- ä¼˜åŒ–è‡ªåŠ¨åˆ‡æ¢æµç¨‹
- å®Œå–„ç›‘æ§å‘Šè­¦æœºåˆ¶
EOF
    
    log "Drill report generated: $REPORT_FILE"
}

# ä¸»ç¨‹åº
case "$DRILL_TYPE" in
    "database")
        database_drill
        ;;
    "redis")
        redis_drill
        ;;
    "application")
        application_drill
        ;;
    "network")
        network_drill
        ;;
    "full")
        full_drill
        ;;
    *)
        echo "Usage: $0 {database|redis|application|network|full}"
        exit 1
        ;;
esac

generate_report
```

### 2. æ¼”ç»ƒæ£€æŸ¥æ¸…å•

#### æ¼”ç»ƒå‰æ£€æŸ¥
```markdown
## å®¹ç¾æ¼”ç»ƒå‰æ£€æŸ¥æ¸…å•

### åŸºç¡€è®¾æ–½æ£€æŸ¥
- [ ] ä¸»å¤‡æ•°æ®ä¸­å¿ƒç½‘ç»œè¿é€šæ€§æ­£å¸¸
- [ ] æ•°æ®åº“ä¸»ä»å¤åˆ¶çŠ¶æ€æ­£å¸¸
- [ ] Redisé›†ç¾¤çŠ¶æ€æ­£å¸¸
- [ ] åº”ç”¨æœåŠ¡å¥åº·çŠ¶æ€æ­£å¸¸
- [ ] ç›‘æ§ç³»ç»Ÿè¿è¡Œæ­£å¸¸
- [ ] å‘Šè­¦é€šçŸ¥æ¸ é“ç•…é€š

### æ•°æ®å¤‡ä»½æ£€æŸ¥
- [ ] æ•°æ®åº“å¤‡ä»½å®Œæ•´æ€§éªŒè¯
- [ ] æ–‡ä»¶å­˜å‚¨å¤‡ä»½éªŒè¯
- [ ] é…ç½®æ–‡ä»¶å¤‡ä»½éªŒè¯
- [ ] åº”ç”¨ä»£ç å¤‡ä»½éªŒè¯

### äººå‘˜å‡†å¤‡
- [ ] æ¼”ç»ƒäººå‘˜åˆ°ä½
- [ ] åº”æ€¥è”ç³»äººç¡®è®¤
- [ ] æ¼”ç»ƒæµç¨‹åŸ¹è®­å®Œæˆ
- [ ] å›æ»šæ–¹æ¡ˆå‡†å¤‡å°±ç»ª

### å·¥å…·å‡†å¤‡
- [ ] ç›‘æ§å·¥å…·æ­£å¸¸
- [ ] è‡ªåŠ¨åŒ–è„šæœ¬æµ‹è¯•
- [ ] é€šä¿¡å·¥å…·å‡†å¤‡
- [ ] æ–‡æ¡£èµ„æ–™é½å…¨
```

#### æ¼”ç»ƒåè¯„ä¼°
```markdown
## å®¹ç¾æ¼”ç»ƒåè¯„ä¼°æ¸…å•

### æ—¶é—´æŒ‡æ ‡è¯„ä¼°
- [ ] RTOç›®æ ‡è¾¾æˆæƒ…å†µï¼ˆç›®æ ‡ï¼šâ‰¤30åˆ†é’Ÿï¼‰
- [ ] RPOç›®æ ‡è¾¾æˆæƒ…å†µï¼ˆç›®æ ‡ï¼šâ‰¤5åˆ†é’Ÿï¼‰
- [ ] æ•…éšœæ£€æµ‹æ—¶é—´
- [ ] åˆ‡æ¢æ‰§è¡Œæ—¶é—´
- [ ] æœåŠ¡æ¢å¤æ—¶é—´

### åŠŸèƒ½éªŒè¯
- [ ] æ•°æ®å®Œæ•´æ€§éªŒè¯
- [ ] ä¸šåŠ¡åŠŸèƒ½éªŒè¯
- [ ] æ€§èƒ½æŒ‡æ ‡éªŒè¯
- [ ] ç”¨æˆ·ä½“éªŒéªŒè¯

### é—®é¢˜è®°å½•
- [ ] æ•…éšœç‚¹è¯†åˆ«
- [ ] æ”¹è¿›å»ºè®®è®°å½•
- [ ] æµç¨‹ä¼˜åŒ–ç‚¹
- [ ] å·¥å…·æ”¹è¿›éœ€æ±‚

### åç»­è¡ŒåŠ¨
- [ ] é—®é¢˜ä¿®å¤è®¡åˆ’
- [ ] æµç¨‹ä¼˜åŒ–å®æ–½
- [ ] åŸ¹è®­æ”¹è¿›è®¡åˆ’
- [ ] ä¸‹æ¬¡æ¼”ç»ƒå®‰æ’
```

## æœ€ä½³å®è·µæ€»ç»“

### 1. è®¾è®¡åŸåˆ™
- **å¤šå±‚é˜²æŠ¤**: ä»ç½‘ç»œã€åº”ç”¨ã€æ•°æ®åº“ã€å­˜å‚¨å¤šä¸ªå±‚é¢è®¾è®¡å®¹ç¾æ–¹æ¡ˆ
- **è‡ªåŠ¨åŒ–ä¼˜å…ˆ**: å°½å¯èƒ½å®ç°æ•…éšœè‡ªåŠ¨æ£€æµ‹å’Œè‡ªåŠ¨åˆ‡æ¢
- **æ¸è¿›å¼åˆ‡æ¢**: é‡‡ç”¨ç°åº¦åˆ‡æ¢æ–¹å¼ï¼Œé™ä½åˆ‡æ¢é£é™©
- **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿ä¸»å¤‡æ•°æ®ä¸­å¿ƒæ•°æ®ä¸€è‡´æ€§

### 2. ç›‘æ§è¦ç‚¹
- **å®æ—¶ç›‘æ§**: 7x24å°æ—¶å®æ—¶ç›‘æ§å…³é”®æŒ‡æ ‡
- **å¤šç»´åº¦å‘Šè­¦**: ä»åŸºç¡€è®¾æ–½åˆ°åº”ç”¨å±‚é¢çš„å…¨æ–¹ä½å‘Šè­¦
- **æ™ºèƒ½å‘Šè­¦**: é¿å…å‘Šè­¦é£æš´ï¼Œå®ç°æ™ºèƒ½å‘Šè­¦èšåˆ
- **å¯è§†åŒ–å±•ç¤º**: æä¾›ç›´è§‚çš„ç›‘æ§å¤§å±å’ŒæŠ¥è¡¨

### 3. è¿ç»´å»ºè®®
- **å®šæœŸæ¼”ç»ƒ**: æ¯æœˆè¿›è¡Œå®¹ç¾æ¼”ç»ƒï¼Œç¡®ä¿æ–¹æ¡ˆæœ‰æ•ˆæ€§
- **æ–‡æ¡£ç»´æŠ¤**: åŠæ—¶æ›´æ–°å®¹ç¾æ–‡æ¡£å’Œæ“ä½œæ‰‹å†Œ
- **äººå‘˜åŸ¹è®­**: å®šæœŸè¿›è¡Œå®¹ç¾åŸ¹è®­ï¼Œæé«˜åº”æ€¥å“åº”èƒ½åŠ›
- **æŒç»­æ”¹è¿›**: æ ¹æ®æ¼”ç»ƒç»“æœæŒç»­ä¼˜åŒ–å®¹ç¾æ–¹æ¡ˆ

### 4. æˆæœ¬æ§åˆ¶
- **èµ„æºå¤ç”¨**: å¤‡ç”¨èµ„æºå¹³æ—¶å¯ç”¨äºæµ‹è¯•ç¯å¢ƒ
- **å¼¹æ€§æ‰©å®¹**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚åŠ¨æ€è°ƒæ•´å¤‡ç”¨èµ„æºè§„æ¨¡
- **äº‘ç«¯å¤‡ä»½**: åˆ©ç”¨äº‘æœåŠ¡é™ä½å¤‡ä»½å­˜å‚¨æˆæœ¬
- **è‡ªåŠ¨åŒ–è¿ç»´**: é€šè¿‡è‡ªåŠ¨åŒ–å‡å°‘äººå·¥è¿ç»´æˆæœ¬

é€šè¿‡ä»¥ä¸Šå®¹ç¾æ–¹æ¡ˆçš„å®æ–½ï¼ŒNSRSå·å¡èµ„æºç®¡ç†ç³»ç»Ÿèƒ½å¤Ÿåœ¨å„ç§ç¾éš¾åœºæ™¯ä¸‹å¿«é€Ÿæ¢å¤æœåŠ¡ï¼Œç¡®ä¿ä¸šåŠ¡è¿ç»­æ€§ï¼Œè¾¾åˆ°99.99%çš„é«˜å¯ç”¨æ€§ç›®æ ‡ã€‚nsrs.com/api/alerts" \
        -H "Content-Type: application/json" \
        -d "{\"level\":\"critical\",\"message\":\"$message\",\"service\":\"mysql-replication\"}"
}

# ä¸»å¾ªç¯
while true; do
    check_replication
    sleep 30
done
```

### 2. æ•°æ®åº“æ•…éšœåˆ‡æ¢è„šæœ¬

```bash
#!/bin/bash
# mysql_failover.sh - MySQLæ•…éšœåˆ‡æ¢è„šæœ¬

MASTER_HOST="10.1.7.10"
SLAVE_HOST="10.1.7.11"
DB_USER="root"
DB_PASS="root_password"
VIP="10.1.7.100"  # è™šæ‹ŸIP
LOG_FILE="/var/log/mysql_failover.log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# æ£€æŸ¥ä¸»åº“çŠ¶æ€
check_master() {
    mysql -h"$MASTER_HOST" -u"$DB_USER" -p"$DB_PASS" \
        -e "SELECT 1" >/dev/null 2>&1
    return $?
}

# æå‡ä»åº“ä¸ºä¸»åº“
promote_slave() {
    log "Promoting slave to master: $SLAVE_HOST"
    
    # åœæ­¢ä»åº“å¤åˆ¶
    mysql -h"$SLAVE_HOST" -u"$DB_USER" -p"$DB_PASS" \
        -e "STOP SLAVE;"
    
    # é‡ç½®ä»åº“çŠ¶æ€
    mysql -h"$SLAVE_HOST" -u"$DB_USER" -p"$DB_PASS" \
        -e "RESET SLAVE ALL;"
    
    # è®¾ç½®ä¸ºå¯å†™
    mysql -h"$SLAVE_HOST" -u"$DB_USER" -p"$DB_PASS" \
        -e "SET GLOBAL read_only = 0; SET GLOBAL super_read_only = 0;"
    
    # åˆ‡æ¢VIPåˆ°æ–°ä¸»åº“
    ssh root@"$SLAVE_HOST" "ip addr add $VIP/24 dev eth0"
    ssh root@"$MASTER_HOST" "ip addr del $VIP/24 dev eth0" 2>/dev/null || true
    
    log "Failover completed. New master: $SLAVE_HOST"
}

# æ›´æ–°åº”ç”¨é…ç½®
update_application_config() {
    log "Updating application database configuration"
    
    # æ›´æ–°Spring Booté…ç½®
    kubectl patch configmap nsrs-config \
        --patch='{"data":{"spring.datasource.url":"jdbc:mysql://'$SLAVE_HOST':3306/nsrs_sim_resource_0"}}'
    
    # é‡å¯åº”ç”¨æœåŠ¡
    kubectl rollout restart deployment/nsrs-application
    
    log "Application configuration updated"
}

# å‘é€é€šçŸ¥
send_notification() {
    local message="MySQL failover completed. New master: $SLAVE_HOST"
    
    # é‚®ä»¶é€šçŸ¥
    echo "$message" | mail -s "MySQL Failover Notification" "admin@nsrs.com"
    
    # é’‰é’‰é€šçŸ¥
    curl -X POST "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
            \"msgtype\": \"text\",
            \"text\": {
                \"content\": \"$message\"
            }
        }"
}

# ä¸»é€»è¾‘
main() {
    log "Starting MySQL failover check"
    
    if ! check_master; then
        log "Master database is down, initiating failover"
        
        promote_slave
        update_application_config
        send_notification
        
        log "Failover process completed"
    else
        log "Master database is healthy"
    fi
}

# æ‰§è¡Œä¸»é€»è¾‘
main "$@"
```

## Rediså®¹ç¾æ–¹æ¡ˆ

### 1. Redis Sentinelé«˜å¯ç”¨é…ç½®

#### Redisä¸»åº“é…ç½® (redis.conf)
```conf
# Redisä¸»åº“é…ç½®
port 6379
bind 0.0.0.0
protected-mode yes
requirepass "redis_password_2024"
masterauth "redis_password_2024"

# æŒä¹…åŒ–é…ç½®
save 900 1
save 300 10
save 60 10000
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis

# AOFé…ç½®
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# å¤åˆ¶é…ç½®
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-ping-slave-period 10
repl-timeout 60
repl-disable-tcp-nodelay no
repl-backlog-size 1mb
repl-backlog-ttl 3600
```

#### Redis Sentinelé…ç½® (sentinel.conf)
```conf
# Sentinelé…ç½®
port 26379
bind 0.0.0.0
protected-mode no

# ç›‘æ§ä¸»åº“
sentinel monitor nsrs-redis 10.1.7.10 6379 2
sentinel auth-pass nsrs-redis redis_password_2024
sentinel down-after-milliseconds nsrs-redis 5000
sentinel parallel-syncs nsrs-redis 1
sentinel failover-timeout nsrs-redis 10000

# é€šçŸ¥è„šæœ¬
sentinel notification-script nsrs-redis /opt/redis/scripts/notify.sh
sentinel client-reconfig-script nsrs-redis /opt/redis/scripts/reconfig.sh

# æ—¥å¿—é…ç½®
logfile /var/log/redis/sentinel.log
loglevel notice
```

#### Sentinelé€šçŸ¥è„šæœ¬
```bash
#!/bin/bash
# /opt/redis/scripts/notify.sh

EVENT_TYPE="$1"
EVENT_NAME="$2"
shift 2
EVENT_ARGS="$@"

LOG_FILE="/var/log/redis/sentinel-events.log"
ALERT_URL="http://monitoring.nsrs.com/api/alerts"

# è®°å½•äº‹ä»¶
echo "$(date): $EVENT_TYPE $EVENT_NAME $EVENT_ARGS" >> "$LOG_FILE"

# å‘é€å‘Šè­¦
case "$EVENT_TYPE" in
    "+sdown")
        MESSAGE="Redis master is subjectively down: $EVENT_ARGS"
        LEVEL="warning"
        ;;
    "+odown")
        MESSAGE="Redis master is objectively down: $EVENT_ARGS"
        LEVEL="critical"
        ;;
    "+failover-triggered")
        MESSAGE="Redis failover triggered: $EVENT_ARGS"
        LEVEL="critical"
        ;;
    "+failover-end")
        MESSAGE="Redis failover completed: $EVENT_ARGS"
        LEVEL="info"
        ;;
    *)
        MESSAGE="Redis sentinel event: $EVENT_TYPE $EVENT_NAME $EVENT_ARGS"
        LEVEL="info"
        ;;
esac

# å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
curl -X POST "$ALERT_URL" \
    -H "Content-Type: application/json" \
    -d "{
        \"level\": \"$LEVEL\",
        \"message\": \"$MESSAGE\",
        \"service\": \"redis-sentinel\",
        \"timestamp\": \"$(date -Iseconds)\"
    }" 2>/dev/null || true

# å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆä»…å…³é”®äº‹ä»¶ï¼‰
if [ "$LEVEL" = "critical" ]; then
    echo "$MESSAGE" | mail -s "Redis Sentinel Alert" "admin@nsrs.com"
fi
```

### 2. Redisé›†ç¾¤å®¹ç¾é…ç½®

#### Spring Boot Redisé…ç½®
```yaml
# application-disaster.yml
spring:
  redis:
    # Sentinelæ¨¡å¼é…ç½®
    sentinel:
      master: nsrs-redis
      nodes:
        - 10.1.7.10:26379
        - 10.1.7.11:26379
        - 10.1.7.12:26379
      password: redis_password_2024
    password: redis_password_2024
    timeout: 3000ms
    
    # è¿æ¥æ± é…ç½®
    lettuce:
      pool:
        max-active: 200
        max-idle: 20
        min-idle: 5
        max-wait: 3000ms
      shutdown-timeout: 100ms
    
    # é›†ç¾¤é…ç½®ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
    cluster:
      nodes:
        - 10.1.7.10:7000
        - 10.1.7.10:7001
        - 10.1.7.11:7000
        - 10.1.7.11:7001
        - 10.1.7.12:7000
        - 10.1.7.12:7001
      max-redirects: 3
```

#### Rediså®¹ç¾åˆ‡æ¢æœåŠ¡
```java
/**
 * Rediså®¹ç¾åˆ‡æ¢æœåŠ¡
 */
@Service
@Slf4j
public class RedisDisasterRecoveryService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private LettuceConnectionFactory connectionFactory;
    
    @Value("${spring.redis.sentinel.nodes}")
    private List<String> sentinelNodes;
    
    /**
     * æ£€æŸ¥Redisè¿æ¥çŠ¶æ€
     */
    @Scheduled(fixedDelay = 30000) // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
    public void checkRedisHealth() {
        try {
            // æ‰§è¡Œpingå‘½ä»¤æ£€æŸ¥è¿æ¥
            String result = redisTemplate.execute((RedisCallback<String>) connection -> {
                return connection.ping();
            });
            
            if (!"PONG".equals(result)) {
                log.warn("Redis health check failed: unexpected response: {}", result);
                handleRedisFailure();
            } else {
                log.debug("Redis health check passed");
            }
            
        } catch (Exception e) {
            log.error("Redis health check failed", e);
            handleRedisFailure();
        }
    }
    
    /**
     * å¤„ç†Redisæ•…éšœ
     */
    private void handleRedisFailure() {
        log.warn("Handling Redis failure, attempting to reconnect");
        
        try {
            // é‡ç½®è¿æ¥
            connectionFactory.resetConnection();
            
            // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
            Thread.sleep(5000);
            
            // é‡æ–°æ£€æŸ¥è¿æ¥
            String result = redisTemplate.execute((RedisCallback<String>) connection -> {
                return connection.ping();
            });
            
            if ("PONG".equals(result)) {
                log.info("Redis connection restored successfully");
                sendRecoveryNotification();
            } else {
                log.error("Redis connection still failed after reset");
                triggerEmergencyMode();
            }
            
        } catch (Exception e) {
            log.error("Failed to handle Redis failure", e);
            triggerEmergencyMode();
        }
    }
    
    /**
     * è§¦å‘åº”æ€¥æ¨¡å¼
     */
    private void triggerEmergencyMode() {
        log.error("Triggering emergency mode due to Redis failure");
        
        // å‘é€ç´§æ€¥å‘Šè­¦
        sendEmergencyAlert();
        
        // å¯ç”¨æœ¬åœ°ç¼“å­˜æ¨¡å¼
        enableLocalCacheMode();
        
        // è®°å½•æ•…éšœäº‹ä»¶
        recordFailureEvent();
    }
    
    /**
     * å¯ç”¨æœ¬åœ°ç¼“å­˜æ¨¡å¼
     */
    private void enableLocalCacheMode() {
        // é€šè¿‡é…ç½®ä¸­å¿ƒåŠ¨æ€åˆ‡æ¢åˆ°æœ¬åœ°ç¼“å­˜
        try {
            // è¿™é‡Œå¯ä»¥é€šè¿‡Nacosç­‰é…ç½®ä¸­å¿ƒåŠ¨æ€ä¿®æ”¹ç¼“å­˜ç­–ç•¥
            log.info("Switching to local cache mode");
            
            // å‘å¸ƒç¼“å­˜æ¨¡å¼åˆ‡æ¢äº‹ä»¶
            ApplicationEventPublisher eventPublisher = 
                ApplicationContextHolder.getApplicationContext();
            eventPublisher.publishEvent(new CacheModeChangedEvent("LOCAL"));
            
        } catch (Exception e) {
            log.error("Failed to enable local cache mode", e);
        }
    }
    
    /**
     * å‘é€æ¢å¤é€šçŸ¥
     */
    private void sendRecoveryNotification() {
        try {
            String message = "Redis connection has been restored at " + new Date();
            
            // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
            sendToMonitoring("info", message);
            
            log.info("Redis recovery notification sent");
            
        } catch (Exception e) {
            log.error("Failed to send recovery notification", e);
        }
    }
    
    /**
     * å‘é€ç´§æ€¥å‘Šè­¦
     */
    private void sendEmergencyAlert() {
        try {
            String message = "Redis cluster is down, emergency mode activated at " + new Date();
            
            // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
            sendToMonitoring("critical", message);
            
            // å‘é€é‚®ä»¶å‘Šè­¦
            sendEmailAlert(message);
            
            // å‘é€çŸ­ä¿¡å‘Šè­¦
            sendSmsAlert(message);
            
            log.error("Emergency alert sent for Redis failure");
            
        } catch (Exception e) {
            log.error("Failed to send emergency alert", e);
        }
    }
    
    /**
     * å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
     */
    private void sendToMonitoring(String level, String message) {
        // å®ç°å‘é€åˆ°ç›‘æ§ç³»ç»Ÿçš„é€»è¾‘
        RestTemplate restTemplate = new RestTemplate();
        
        Map<String, Object> alert = new HashMap<>();
        alert.put("level", level);
        alert.put("message", message);
        alert.put("service", "redis-cluster");
        alert.put("timestamp", Instant.now().toString());
        
        try {
            restTemplate.postForObject(
                "http://monitoring.nsrs.com/api/alerts", 
                alert, 
                String.class
            );
        } catch (Exception e) {
            log.error("Failed to send alert to monitoring system", e);
        }
    }
    
    /**
     * å‘é€é‚®ä»¶å‘Šè­¦
     */
    private void sendEmailAlert(String message) {
        // å®ç°é‚®ä»¶å‘Šè­¦é€»è¾‘
        // å¯ä»¥ä½¿ç”¨Spring Mailæˆ–è€…ç¬¬ä¸‰æ–¹é‚®ä»¶æœåŠ¡
    }
    
    /**
     * å‘é€çŸ­ä¿¡å‘Šè­¦
     */
    private void sendSmsAlert(String message) {
        // å®ç°çŸ­ä¿¡å‘Šè­¦é€»è¾‘
        // å¯ä»¥ä½¿ç”¨é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡ç­‰
    }
    
    /**
     * è®°å½•æ•…éšœäº‹ä»¶
     */
    private void recordFailureEvent() {
        try {
            // è®°å½•åˆ°æ•°æ®åº“æˆ–æ—¥å¿—ç³»ç»Ÿ
            log.error("Redis failure event recorded at {}", new Date());
            
            // å¯ä»¥å°†æ•…éšœäº‹ä»¶å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ç”¨äºåç»­åˆ†æ
            
        } catch (Exception e) {
            log.error("Failed to record failure event", e);
        }
    }
}

/**
 * ç¼“å­˜æ¨¡å¼åˆ‡æ¢äº‹ä»¶
 */
public class CacheModeChangedEvent extends ApplicationEvent {
    private final String mode;
    
    public CacheModeChangedEvent(String mode) {
        super(mode);
        this.mode = mode;
    }
    
    public String getMode() {
        return mode;
    }
}
```

## åº”ç”¨æœåŠ¡å®¹ç¾æ–¹æ¡ˆ

### 1. Kuberneteså¤šé›†ç¾¤éƒ¨ç½²

#### ä¸»é›†ç¾¤éƒ¨ç½²é…ç½®
```yaml
# nsrs-deployment-primary.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nsrs-application
  namespace: nsrs-prod
  labels:
    app: nsrs-application
    cluster: primary
spec:
  replicas: 6
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 1
  selector:
    matchLabels:
      app: nsrs-application
  template:
    metadata:
      labels:
        app: nsrs-application
        cluster: primary
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - nsrs-application
              topologyKey: kubernetes.io/hostname
      containers:
      - name: nsrs-application
        image: nsrs/application:v1.0.0
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod,primary"
        - name: DATABASE_URL
          value: "jdbc:mysql://mysql-primary.nsrs.com:3306/nsrs_sim_resource_0"
        - name: REDIS_SENTINEL_NODES
          value: "redis-sentinel-1:26379,redis-sentinel-2:26379,redis-sentinel-3:26379"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 10
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
        - name: logs-volume
          mountPath: /app/logs
      volumes:
      - name: config-volume
        configMap:
          name: nsrs-config
      - name: logs-volume
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: nsrs-application-service
  namespace: nsrs-prod
spec:
  selector:
    app: nsrs-application
  ports:
  - port: 80
    targetPort: 8080
    name: http
  type: ClusterIP
```

#### å¤‡é›†ç¾¤éƒ¨ç½²é…ç½®
```yaml
# nsrs-deployment-backup.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nsrs-application
  namespace: nsrs-prod
  labels:
    app: nsrs-application
    cluster: backup
spec:
  replicas: 3  # å¤‡é›†ç¾¤å‰¯æœ¬æ•°è¾ƒå°‘
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  selector:
    matchLabels:
      app: nsrs-application
  template:
    metadata:
      labels:
        app: nsrs-application
        cluster: backup
    spec:
      containers:
      - name: nsrs-application
        image: nsrs/application:v1.0.0
        ports:
        - containerPort: 8080
          name: http
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod,backup"
        - name: DATABASE_URL
          value: "jdbc:mysql://mysql-backup.nsrs.com:3306/nsrs_sim_resource_0"
        - name: REDIS_SENTINEL_NODES
          value: "redis-sentinel-backup-1:26379,redis-sentinel-backup-2:26379,redis-sentinel-backup-3:26379"
        resources:
          requests:
            memory: "1Gi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
```

### 2. è·¨é›†ç¾¤æµé‡åˆ‡æ¢

#### Istioæµé‡ç®¡ç†é…ç½®
```yaml
# traffic-management.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: nsrs-traffic-split
  namespace: nsrs-prod
spec:
  hosts:
  - nsrs.example.com
  gateways:
  - nsrs-gateway
  http:
  - match:
    - headers:
        canary:
          exact: "true"
    route:
    - destination:
        host: nsrs-application-service
        subset: backup
      weight: 100
  - route:
    - destination:
        host: nsrs-application-service
        subset: primary
      weight: 100
    fault:
      abort:
        percentage:
          value: 0.1
        httpStatus: 500
    timeout: 30s
    retries:
      attempts: 3
      perTryTimeout: 10s
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: nsrs-destination-rule
  namespace: nsrs-prod
spec:
  host: nsrs-application-service
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        maxRequestsPerConnection: 10
    loadBalancer:
      simple: LEAST_CONN
    outlierDetection:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50
  subsets:
  - name: primary
    labels:
      cluster: primary
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 200
  - name: backup
    labels:
      cluster: backup
    trafficPolicy:
      connectionPool:
        tcp:
          maxConnections: 100
```

#### è‡ªåŠ¨æ•…éšœåˆ‡æ¢è„šæœ¬
```bash
#!/bin/bash
# cluster_failover.sh - é›†ç¾¤æ•…éšœåˆ‡æ¢è„šæœ¬

PRIMARY_CLUSTER="primary"
BACKUP_CLUSTER="backup"
HEALTH_CHECK_URL="https://nsrs.example.com/actuator/health"
KUBECTL_PRIMARY="kubectl --context=primary-cluster"
KUBECTL_BACKUP="kubectl --context=backup-cluster"
LOG_FILE="/var/log/cluster_failover.log"
ALERT_WEBHOOK="https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"

# æ—¥å¿—å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# å¥åº·æ£€æŸ¥
health_check() {
    local cluster="$1"
    local url="$2"
    
    local response=$(curl -s -o /dev/null -w "%{http_code}" "$url" --max-time 10)
    
    if [ "$response" = "200" ]; then
        return 0
    else
        log "Health check failed for $cluster: HTTP $response"
        return 1
    fi
}

# åˆ‡æ¢åˆ°å¤‡é›†ç¾¤
failover_to_backup() {
    log "Initiating failover to backup cluster"
    
    # æ‰©å®¹å¤‡é›†ç¾¤
    log "Scaling up backup cluster"
    $KUBECTL_BACKUP scale deployment/nsrs-application --replicas=6 -n nsrs-prod
    
    # ç­‰å¾…å¤‡é›†ç¾¤å°±ç»ª
    log "Waiting for backup cluster to be ready"
    $KUBECTL_BACKUP wait --for=condition=available --timeout=300s deployment/nsrs-application -n nsrs-prod
    
    if [ $? -eq 0 ]; then
        # æ›´æ–°Istioæµé‡è·¯ç”±
        log "Updating traffic routing to backup cluster"
        
        cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: nsrs-traffic-split
  namespace: nsrs-prod
spec:
  hosts:
  - nsrs.example.com
  gateways:
  - nsrs-gateway
  http:
  - route:
    - destination:
        host: nsrs-application-service
        subset: backup
      weight: 100
EOF
        
        log "Failover to backup cluster completed successfully"
        send_notification "âœ… Failover completed: Traffic switched to backup cluster"
        
        return 0
    else
        log "ERROR: Backup cluster failed to become ready"
        send_notification "âŒ Failover failed: Backup cluster not ready"
        return 1
    fi
}

# åˆ‡æ¢å›ä¸»é›†ç¾¤
failback_to_primary() {
    log "Initiating failback to primary cluster"
    
    # æ£€æŸ¥ä¸»é›†ç¾¤å¥åº·çŠ¶æ€
    if health_check "primary" "$HEALTH_CHECK_URL"; then
        # é€æ­¥åˆ‡æ¢æµé‡
        log "Gradually switching traffic back to primary cluster"
        
        # 50/50 åˆ†æµ
        cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: nsrs-traffic-split
  namespace: nsrs-prod
spec:
  hosts:
  - nsrs.example.com
  gateways:
  - nsrs-gateway
  http:
  - route:
    - destination:
        host: nsrs-application-service
        subset: primary
      weight: 50
    - destination:
        host: nsrs-application-service
        subset: backup
      weight: 50
EOF
        
        sleep 60
        
        # æ£€æŸ¥ä¸»é›†ç¾¤æ˜¯å¦ç¨³å®š
        if health_check "primary" "$HEALTH_CHECK_URL"; then
            # å®Œå…¨åˆ‡æ¢åˆ°ä¸»é›†ç¾¤
            cat <<EOF | kubectl apply -f -
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: nsrs-traffic-split
  namespace: nsrs-prod
spec:
  hosts:
  - nsrs.example.com
  gateways:
  - nsrs-gateway
  http:
  - route:
    - destination:
        host: nsrs-application-service
        subset: primary
      weight: 100
EOF
            
            # ç¼©å®¹å¤‡é›†ç¾¤
            log "Scaling down backup cluster"
            $KUBECTL_BACKUP scale deployment/nsrs-application --replicas=2 -n nsrs-prod
            
            log "Failback to primary cluster completed successfully"
            send_notification "âœ… Failback completed: Traffic switched back to primary cluster"
            
            return 0
        else
            log "ERROR: Primary cluster still unhealthy, keeping backup active"
            return 1
        fi
    else
        log "Primary cluster is still unhealthy, failback aborted"
        return 1
    fi
}

# å‘é€é€šçŸ¥
send_notification() {
    local message="$1"
    
    # Slacké€šçŸ¥
    curl -X POST "$ALERT_WEBHOOK" \
        -H "Content-Type: application/json" \
        -d "{
            \"text\": \"$message\",
            \"username\": \"NSRS Failover Bot\",
            \"icon_emoji\": \":warning:\"
        }"
    
    # é‚®ä»¶é€šçŸ¥
    echo "$message" | mail -s "NSRS Cluster Failover Notification" "admin@nsrs.com"
    
    log "Notification sent: $message"
}

# ä¸»ç›‘æ§å¾ªç¯
main_monitor() {
    local consecutive_failures=0
    local max_failures=3
    local check_interval=30
    local current_cluster="primary"
    
    log "Starting cluster monitoring"
    
    while true; do
        if health_check "$current_cluster" "$HEALTH_CHECK_URL"; then
            consecutive_failures=0
            
            # å¦‚æœå½“å‰åœ¨å¤‡é›†ç¾¤ä¸”ä¸»é›†ç¾¤æ¢å¤ï¼Œå°è¯•åˆ‡æ¢å›ä¸»é›†ç¾¤
            if [ "$current_cluster" = "backup" ]; then
                if health_check "primary" "$HEALTH_CHECK_URL"; then
                    log "Primary cluster appears healthy, attempting failback"
                    if failback_to_primary; then
                        current_cluster="primary"
                    fi
                fi
            fi
        else
            consecutive_failures=$((consecutive_failures + 1))
            log "Health check failed ($consecutive_failures/$max_failures)"
            
            if [ $consecutive_failures -ge $max_failures ]; then
                if [ "$current_cluster" = "primary" ]; then
                    log "Primary cluster failed, initiating failover"
                    if failover_to_backup; then
                        current_cluster="backup"
                        consecutive_failures=0
                    fi
                else
                    log "ERROR: Backup cluster also failed!"
                    send_notification "ğŸš¨ CRITICAL: Both clusters are down!"
                fi
            fi
        fi
        
        sleep $check_interval
    done
}

# æ‰§è¡Œä¸»ç›‘æ§
case "${1:-monitor}" in
    "monitor")
        main_monitor
        ;;
    "failover")
        failover_to_backup
        ;;
    "failback")
        failback_to_primary
        ;;
    *)
        echo "Usage: $0 {monitor|failover|failback}"
        exit 1
        ;;
esac
```

## æ–‡ä»¶å­˜å‚¨å®¹ç¾æ–¹æ¡ˆ

### 1. åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿé…ç½®

#### MinIOé›†ç¾¤éƒ¨ç½²
```yaml
# minio-cluster.yaml
apiVersion: v1
kind: Service
metadata:
  name: minio-service
  namespace: nsrs-storage
spec:
  clusterIP: None
  ports:
  - port: 9000
    name: minio
  - port: 9001
    name: console
  selector:
    app: minio
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: minio
  namespace: nsrs-storage
spec:
  serviceName: minio-service
  replicas: 4
  selector:
    matchLabels:
      app: minio
  template:
    metadata:
      labels:
        app: minio
    spec:
      containers:
      - name: minio
        image: minio/minio:RELEASE.2024-01-01T00-00-00Z
        args:
        - server
        - http://minio-{0...3}.minio-service.nsrs-storage.svc.cluster.local/data
        - --console-address
        - ":9001"
        env:
        - name: MINIO_ROOT_USER
          value: "admin"
        - name: MINIO_ROOT_PASSWORD
          value: "admin123456"
        - name: MINIO_STORAGE_CLASS_STANDARD
          value: "EC:2"
        ports:
        - containerPort: 9000
          name: minio
        - containerPort: 9001
          name: console
        volumeMounts:
        - name: data
          mountPath: /data
        livenessProbe:
          httpGet:
            path: /minio/health/live
            port: 9000
          initialDelaySeconds: 120
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /minio/health/ready
            port: 9000
          initialDelaySeconds: 120
          periodSeconds: 20
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 100Gi
      storageClassName: fast-ssd
```

#### æ–‡ä»¶åŒæ­¥æœåŠ¡
```java
/**
 * æ–‡ä»¶åŒæ­¥æœåŠ¡
 */
@Service
@Slf4j
public class FileReplicationService {
    
    @Autowired
    private MinioClient primaryMinioClient;
    
    @Autowired
    private MinioClient backupMinioClient;
    
    @Value("${minio.bucket.name}")
    private String bucketName;
    
    /**
     * åŒæ­¥æ–‡ä»¶åˆ°å¤‡ä»½å­˜å‚¨
     */
    @Async("fileReplicationExecutor")
    public CompletableFuture<Void> replicateFile(String objectName) {
        try {
            log.debug("Starting file replication for: {}", objectName);
            
            // ä»ä¸»å­˜å‚¨ä¸‹è½½æ–‡ä»¶
            try (InputStream inputStream = primaryMinioClient.getObject(
                    GetObjectArgs.builder()
                            .bucket(bucketName)
                            .object(objectName)
                            .build())) {
                
                // è·å–æ–‡ä»¶å…ƒæ•°æ®
                StatObjectResponse stat = primaryMinioClient.statObject(
                        StatObjectArgs.builder()
                                .bucket(bucketName)
                                .object(objectName)
                                .build());
                
                // ä¸Šä¼ åˆ°å¤‡ä»½å­˜å‚¨
                backupMinioClient.putObject(
                        PutObjectArgs.builder()
                                .bucket(bucketName)
                                .object(objectName)
                                .stream(inputStream, stat.size(), -1)
                                .contentType(stat.contentType())
                                .userMetadata(stat.userMetadata())
                                .build());
                
                log.info("File replication completed for: {}", objectName);
                
            }
            
        } catch (Exception e) {
            log.error("File replication failed for: {}", objectName, e);
            throw new RuntimeException("File replication failed", e);
        }
        
        return CompletableFuture.completedFuture(null);
    }
    
    /**
     * éªŒè¯æ–‡ä»¶åŒæ­¥çŠ¶æ€
     */
    public boolean verifyReplication(String objectName) {
        try {
            // è·å–ä¸»å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
            StatObjectResponse primaryStat = primaryMinioClient.statObject(
                    StatObjectArgs.builder()
                            .bucket(bucketName)
                            .object(objectName)
                            .build());
            
            // è·å–å¤‡ä»½å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
            StatObjectResponse backupStat = backupMinioClient.statObject(
                    StatObjectArgs.builder()
                            .bucket(bucketName)
                            .object(objectName)
                            .build());
            
            // æ¯”è¾ƒæ–‡ä»¶å¤§å°å’ŒETag
            boolean sizeMatch = primaryStat.size() == backupStat.size();
            boolean etagMatch = Objects.equals(primaryStat.etag(), backupStat.etag());
            
            if (sizeMatch && etagMatch) {
                log.debug("File replication verified for: {}", objectName);
                return true;
            } else {
                log.warn("File replication verification failed for: {} (size: {}/{}, etag: {}/{})", 
                        objectName, primaryStat.size(), backupStat.size(), 
                        primaryStat.etag(), backupStat.etag());
                return false;
            }
            
        } catch (Exception e) {
            log.error("File replication verification failed for: {}", objectName, e);
            return false;
        }
    }
    
    /**
     * æ‰¹é‡åŒæ­¥æ–‡ä»¶
     */
    @Scheduled(fixedDelay = 300000) // æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void batchReplication() {
        try {
            log.debug("Starting batch file replication");
            
            // è·å–ä¸»å­˜å‚¨ä¸­çš„æ‰€æœ‰æ–‡ä»¶
            Iterable<Result<Item>> results = primaryMinioClient.listObjects(
                    ListObjectsArgs.builder()
                            .bucket(bucketName)
                            .recursive(true)
                            .build());
            
            List<CompletableFuture<Void>> replicationTasks = new ArrayList<>();
            
            for (Result<Item> result : results) {
                Item item = result.get();
                String objectName = item.objectName();
                
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦éœ€è¦åŒæ­¥
                if (!verifyReplication(objectName)) {
                    CompletableFuture<Void> task = replicateFile(objectName);
                    replicationTasks.add(task);
                }
            }
            
            // ç­‰å¾…æ‰€æœ‰åŒæ­¥ä»»åŠ¡å®Œæˆ
            CompletableFuture.allOf(replicationTasks.toArray(new CompletableFuture[0]))
                    .get(30, TimeUnit.MINUTES);
            
            log.info("Batch file replication completed, {} files processed", 
                    replicationTasks.size());
            
        } catch (Exception e) {
            log.error("Batch file replication failed", e);
        }
    }
    
    /**
     * æ•…éšœåˆ‡æ¢åˆ°å¤‡ä»½å­˜å‚¨
     */
    public void failoverToBackupStorage() {
        log.warn("Failing over to backup storage");
        
        try {
            // æ›´æ–°é…ç½®ï¼Œå°†å¤‡ä»½å­˜å‚¨è®¾ç½®ä¸ºä¸»å­˜å‚¨
            // è¿™é‡Œå¯ä»¥é€šè¿‡é…ç½®ä¸­å¿ƒåŠ¨æ€ä¿®æ”¹å­˜å‚¨é…ç½®
            
            // å‘å¸ƒå­˜å‚¨åˆ‡æ¢äº‹ä»¶
            ApplicationEventPublisher eventPublisher = 
                ApplicationContextHolder.getApplicationContext();
            eventPublisher.publishEvent(new StorageFailoverEvent("BACKUP"));
            
            log.info("Storage failover completed");
            
        } catch (Exception e) {
            log.error("Storage failover failed", e);
        }
    }
}

/**
 * å­˜å‚¨æ•…éšœåˆ‡æ¢äº‹ä»¶
 */
public class StorageFailoverEvent extends ApplicationEvent {
    private final String targetStorage;
    
    public StorageFailoverEvent(String targetStorage) {
        super(targetStorage);
        this.targetStorage = targetStorage;
    }
    
    public String getTargetStorage() {
        return targetStorage;
    }
}
```

## ç½‘ç»œå®¹ç¾æ–¹æ¡ˆ

### 1. å¤šçº¿è·¯æ¥å…¥é…ç½®

#### BGPå¤šçº¿è·¯é…ç½®
```bash
# /etc/frr/frr.conf - FRRouting BGPé…ç½®
!
frr version 8.0
frr defaults traditional
!
router bgp 65001
 bgp router-id 10.1.7.1
 bgp log-neighbor-changes
 
 ! ç”µä¿¡çº¿è·¯
 neighbor 202.96.128.1 remote-as 4134
 neighbor 202.96.128.1 description "China Telecom"
 neighbor 202.96.128.1 password telecom_password
 
 ! è”é€šçº¿è·¯
 neighbor 221.5.88.1 remote-as 4837
 neighbor 221.5.88.1 description "China Unicom"
 neighbor 221.5.88.1 password unicom_password
 
 ! ç§»åŠ¨çº¿è·¯
 neighbor 211.136.112.1 remote-as 9808
 neighbor 211.136.112.1 description "China Mobile"
 neighbor 211.136.112.1 password mobile_password
 
 ! ç½‘ç»œå®£å‘Š
 network 10.1.7.0/24
 network 192.168.100.0/24
 
 ! è·¯ç”±ç­–ç•¥
 neighbor 202.96.128.1 route-map TELECOM-OUT out
 neighbor 221.5.88.1 route-map UNICOM-OUT out
 neighbor 211.136.112.1 route-map MOBILE-OUT out
!
! è·¯ç”±æ˜ å°„
route-map TELECOM-OUT permit 10
 set local-preference 100
 set community 4134:100
!
route-map UNICOM-OUT permit 10
 set local-preference 90
 set community 4837:100
!
route-map MOBILE-OUT permit 10
 set local-preference 80
 set community 9808:100
!
line vty
!
```

#### ç½‘ç»œç›‘æ§è„šæœ¬
```bash
#!/bin/bash
# network_monitor.sh - ç½‘ç»œçº¿è·¯ç›‘æ§è„šæœ¬

# é…ç½®å‚æ•°
TELECOM_GW="202.96.128.1"
UNICOM_GW="221.5.88.1"
MOBILE_GW="211.136.112.1"
TEST_HOSTS=("8.8.8.8" "114.114.114.114" "223.5.5.5")
LOG_FILE="/var/log/network_monitor.log"
ALERT_THRESHOLD=3  # è¿ç»­å¤±è´¥æ¬¡æ•°é˜ˆå€¼

# çº¿è·¯çŠ¶æ€
declare -A line_status
declare -A failure_count

line_status["telecom"]=1
line_status["unicom"]=1
line_status["mobile"]=1

failure_count["telecom"]=0
failure_count["unicom"]=0
failure_count["mobile"]=0

# æ—¥å¿—å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# æµ‹è¯•ç½‘ç»œè¿é€šæ€§
test_connectivity() {
    local gateway="$1"
    local line_name="$2"
    
    # é€šè¿‡æŒ‡å®šç½‘å…³pingæµ‹è¯•ä¸»æœº
    for host in "${TEST_HOSTS[@]}"; do
        if ping -c 3 -W 5 -I "$gateway" "$host" >/dev/null 2>&1; then
            return 0
        fi
    done
    
    return 1
}

# æ£€æŸ¥çº¿è·¯çŠ¶æ€
check_line_status() {
    local gateway="$1"
    local line_name="$2"
    
    if test_connectivity "$gateway" "$line_name"; then
        if [ "${line_status[$line_name]}" -eq 0 ]; then
            log "$line_name line recovered"
            line_status["$line_name"]=1
            failure_count["$line_name"]=0
            send_recovery_alert "$line_name"
            update_routing_policy
        fi
        failure_count["$line_name"]=0
    else
        failure_count["$line_name"]=$((failure_count["$line_name"] + 1))
        log "$line_name line test failed (${failure_count[$line_name]}/$ALERT_THRESHOLD)"
        
        if [ "${failure_count[$line_name]}" -ge "$ALERT_THRESHOLD" ] && [ "${line_status[$line_name]}" -eq 1 ]; then
            log "$line_name line is down"
            line_status["$line_name"]=0
            send_failure_alert "$line_name"
            update_routing_policy
        fi
    fi
}

# æ›´æ–°è·¯ç”±ç­–ç•¥
update_routing_policy() {
    log "Updating routing policy based on line status"
    
    # è®¡ç®—å¯ç”¨çº¿è·¯
    local available_lines=()
    
    if [ "${line_status[telecom]}" -eq 1 ]; then
        available_lines+=("telecom")
    fi
    
    if [ "${line_status[unicom]}" -eq 1 ]; then
        available_lines+=("unicom")
    fi
    
    if [ "${line_status[mobile]}" -eq 1 ]; then
        available_lines+=("mobile")
    fi
    
    if [ ${#available_lines[@]} -eq 0 ]; then
        log "ERROR: All network lines are down!"
        send_critical_alert "All network lines are down"
        return
    fi
    
    # æ ¹æ®å¯ç”¨çº¿è·¯æ•°é‡è°ƒæ•´æƒé‡
    case ${#available_lines[@]} in
        3)
            # æ‰€æœ‰çº¿è·¯å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤æƒé‡
            vtysh -c "configure terminal" -c "router bgp 65001" \
                -c "neighbor 202.96.128.1 weight 100" \
                -c "neighbor 221.5.88.1 weight 90" \
                -c "neighbor 211.136.112.1 weight 80"
            ;;
        2)
            # ä¸¤æ¡çº¿è·¯å¯ç”¨ï¼Œå¹³å‡åˆ†é…æƒé‡
            if [[ " ${available_lines[@]} " =~ " telecom " ]] && [[ " ${available_lines[@]} " =~ " unicom " ]]; then
                vtysh -c "configure terminal" -c "router bgp 65001" \
                    -c "neighbor 202.96.128.1 weight 100" \
                    -c "neighbor 221.5.88.1 weight 100" \
                    -c "neighbor 211.136.112.1 weight 0"
            elif [[ " ${available_lines[@]} " =~ " telecom " ]] && [[ " ${available_lines[@]} " =~ " mobile " ]]; then
                vtysh -c "configure terminal" -c "router bgp 65001" \
                    -c "neighbor 202.96.128.1 weight 100" \
                    -c "neighbor 221.5.88.1 weight 0" \
                    -c "neighbor 211.136.112.1 weight 100"
            else
                vtysh -c "configure terminal" -c "router bgp 65001" \
                    -c "neighbor 202.96.128.1 weight 0" \
                    -c "neighbor 221.5.88.1 weight 100" \
                    -c "neighbor 211.136.112.1 weight 100"
            fi
            ;;
        1)
            # åªæœ‰ä¸€æ¡çº¿è·¯å¯ç”¨ï¼Œå…¨éƒ¨æƒé‡ç»™è¯¥çº¿è·¯
            if [[ " ${available_lines[@]} " =~ " telecom " ]]; then
                vtysh -c "configure terminal" -c "router bgp 65001" \
                    -c "neighbor 202.96.128.1 weight 100" \
                    -c "neighbor 221.5.88.1 weight 0" \
                    -c "neighbor 211.136.112.1 weight 0"
            elif [[ " ${available_lines[@]} " =~ " unicom " ]]; then
                vtysh -c "configure terminal" -c "router bgp 65001" \
                    -c "neighbor 202.96.128.1 weight 0" \
                    -c "neighbor 221.5.88.1 weight 100" \
                    -c "neighbor 211.136.112.1 weight 0"
            else
                vtysh -c "configure terminal" -c "router bgp 65001" \
                    -c "neighbor 202.96.128.1 weight 0" \
                    -c "neighbor 221.5.88.1 weight 0" \
                    -c "neighbor 211.136.112.1 weight 100"
            fi
            ;;
    esac
    
    log "Routing policy updated, available lines: ${available_lines[*]}"
}

# å‘é€æ•…éšœå‘Šè­¦
send_failure_alert() {
    local line_name="$1"
    local message="Network line $line_name is down at $(date)"
    
    # å‘é€é‚®ä»¶
    echo "$message" | mail -s "Network Line Failure Alert" "admin@nsrs.com"
    
    # å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    curl -X POST "http://monitoring.nsrs.com/api/alerts" \
        -H "Content-Type: application/json" \
        -d "{
            \"level\": \"critical\",
            \"message\": \"$message\",
            \"service\": \"network-$line_name\"
        }"
    
    log "Failure alert sent for $line_name line"
}

# å‘é€æ¢å¤é€šçŸ¥
send_recovery_alert() {
    local line_name="$1"
    local message="Network line $line_name has recovered at $(date)"
    
    # å‘é€é‚®ä»¶
    echo "$message" | mail -s "Network Line Recovery Notification" "admin@nsrs.com"
    
    # å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    curl -X POST "http://monitoring.