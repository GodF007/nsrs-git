# 搜索引擎架构设计详解

基于Elasticsearch的NSRS号卡资源管理系统搜索引擎解决方案

## 目录

- [搜索引擎概述](#搜索引擎概述)
- [核心枚举定义](#核心枚举定义)
- [核心实体设计](#核心实体设计)
- [搜索服务实现](#搜索服务实现)
- [业务场景应用](#业务场景应用)
- [Elasticsearch集群配置](#elasticsearch集群配置)
- [性能优化](#性能优化)
- [最佳实践](#最佳实践)

## 搜索引擎概述

### 设计目标

- **全文检索**: 支持IMSI、MSISDN、ICCID等资源的全文搜索
- **实时搜索**: 数据变更实时同步到搜索引擎
- **聚合分析**: 支持复杂的统计分析和数据聚合
- **高性能**: 毫秒级响应，支持高并发查询
- **高可用**: 集群部署，故障自动恢复

### 搜索引擎架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    NSRS搜索引擎架构                           │
├─────────────────────────────────────────────────────────────┤
│                      应用层                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ IMSI Search │ │ SIM Search  │ │Report Search│           │
│  │   Service   │ │   Service   │ │   Service   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├─────────────────────────────────────────────────────────────┤
│                    搜索引擎层                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Elasticsearch Cluster                     │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐      │ │
│  │  │ Master1 │ │ Master2 │ │ Data1   │ │ Data2   │      │ │
│  │  │  Node   │ │  Node   │ │  Node   │ │  Node   │      │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘      │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐                  │ │
│  │  │ Coord1  │ │ Coord2  │ │ Ingest  │                  │ │
│  │  │  Node   │ │  Node   │ │  Node   │                  │ │
│  │  └─────────┘ └─────────┘ └─────────┘                  │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                    数据同步层                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   Logstash  │ │    Canal    │ │   Beats     │           │
│  │    ETL      │ │  Binlog同步  │ │  日志收集    │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
├─────────────────────────────────────────────────────────────┤
│                      数据源                                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │   MySQL     │ │    Redis    │ │ Application │           │
│  │  Database   │ │    Cache    │ │    Logs     │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

## 核心枚举定义

### 1. 搜索类型枚举

```java
/**
 * 搜索类型枚举
 */
public enum SearchType {
    
    // 精确匹配
    EXACT_MATCH("EXACT_MATCH", "精确匹配"),
    
    // 模糊搜索
    FUZZY_SEARCH("FUZZY_SEARCH", "模糊搜索"),
    
    // 前缀匹配
    PREFIX_MATCH("PREFIX_MATCH", "前缀匹配"),
    
    // 通配符搜索
    WILDCARD_SEARCH("WILDCARD_SEARCH", "通配符搜索"),
    
    // 正则表达式
    REGEX_SEARCH("REGEX_SEARCH", "正则表达式搜索"),
    
    // 范围搜索
    RANGE_SEARCH("RANGE_SEARCH", "范围搜索"),
    
    // 全文搜索
    FULL_TEXT_SEARCH("FULL_TEXT_SEARCH", "全文搜索");
    
    private final String code;
    private final String description;
    
    SearchType(String code, String description) {
        this.code = code;
        this.description = description;
    }
    
    // getters...
}
```

### 2. 索引类型枚举

```java
/**
 * 索引类型枚举
 */
public enum IndexType {
    
    // IMSI资源索引
    IMSI_RESOURCE("imsi_resource", "IMSI资源索引"),
    
    // MSISDN资源索引
    MSISDN_RESOURCE("msisdn_resource", "MSISDN资源索引"),
    
    // SIM卡索引
    SIM_CARD("sim_card", "SIM卡索引"),
    
    // 用户索引
    USER("user", "用户索引"),
    
    // 计费记录索引
    BILLING_RECORD("billing_record", "计费记录索引"),
    
    // 操作日志索引
    OPERATION_LOG("operation_log", "操作日志索引"),
    
    // 系统日志索引
    SYSTEM_LOG("system_log", "系统日志索引");
    
    private final String indexName;
    private final String description;
    
    IndexType(String indexName, String description) {
        this.indexName = indexName;
        this.description = description;
    }
    
    // getters...
}
```

### 3. 聚合类型枚举

```java
/**
 * 聚合类型枚举
 */
public enum AggregationType {
    
    // 计数聚合
    COUNT("count", "计数聚合"),
    
    // 求和聚合
    SUM("sum", "求和聚合"),
    
    // 平均值聚合
    AVG("avg", "平均值聚合"),
    
    // 最大值聚合
    MAX("max", "最大值聚合"),
    
    // 最小值聚合
    MIN("min", "最小值聚合"),
    
    // 分组聚合
    TERMS("terms", "分组聚合"),
    
    // 日期直方图聚合
    DATE_HISTOGRAM("date_histogram", "日期直方图聚合"),
    
    // 范围聚合
    RANGE("range", "范围聚合"),
    
    // 百分位聚合
    PERCENTILES("percentiles", "百分位聚合");
    
    private final String type;
    private final String description;
    
    AggregationType(String type, String description) {
        this.type = type;
        this.description = description;
    }
    
    // getters...
}
```

## 核心实体设计

### 1. 搜索请求实体

```java
/**
 * 搜索请求实体
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SearchRequest {
    
    /**
     * 索引名称
     */
    private String indexName;
    
    /**
     * 搜索关键词
     */
    private String keyword;
    
    /**
     * 搜索类型
     */
    private SearchType searchType;
    
    /**
     * 搜索字段
     */
    private List<String> searchFields;
    
    /**
     * 过滤条件
     */
    private Map<String, Object> filters;
    
    /**
     * 排序条件
     */
    private List<SortField> sortFields;
    
    /**
     * 分页参数
     */
    private PageRequest pageRequest;
    
    /**
     * 聚合查询
     */
    private List<AggregationQuery> aggregations;
    
    /**
     * 高亮字段
     */
    private List<String> highlightFields;
    
    /**
     * 是否包含源数据
     */
    private Boolean includeSource;
    
    /**
     * 包含字段
     */
    private List<String> includeFields;
    
    /**
     * 排除字段
     */
    private List<String> excludeFields;
    
    /**
     * 搜索超时时间（毫秒）
     */
    private Long timeoutMs;
}
```

### 2. 搜索响应实体

```java
/**
 * 搜索响应实体
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class SearchResponse<T> {
    
    /**
     * 搜索结果
     */
    private List<SearchHit<T>> hits;
    
    /**
     * 总命中数
     */
    private Long totalHits;
    
    /**
     * 最大得分
     */
    private Float maxScore;
    
    /**
     * 搜索耗时（毫秒）
     */
    private Long took;
    
    /**
     * 是否超时
     */
    private Boolean timedOut;
    
    /**
     * 聚合结果
     */
    private Map<String, Object> aggregations;
    
    /**
     * 分页信息
     */
    private PageInfo pageInfo;
    
    /**
     * 搜索建议
     */
    private List<SearchSuggestion> suggestions;
}
```

### 3. IMSI资源搜索文档

```java
/**
 * IMSI资源搜索文档
 */
@Document(indexName = "imsi_resource")
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ImsiResourceDocument {
    
    @Id
    private String id;
    
    /**
     * IMSI号码
     */
    @Field(type = FieldType.Keyword)
    private String imsi;
    
    /**
     * IMSI状态
     */
    @Field(type = FieldType.Keyword)
    private String status;
    
    /**
     * 用户ID
     */
    @Field(type = FieldType.Keyword)
    private String userId;
    
    /**
     * 供应商ID
     */
    @Field(type = FieldType.Keyword)
    private String supplierId;
    
    /**
     * 供应商名称
     */
    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String supplierName;
    
    /**
     * 号段
     */
    @Field(type = FieldType.Keyword)
    private String numberSegment;
    
    /**
     * 地区代码
     */
    @Field(type = FieldType.Keyword)
    private String regionCode;
    
    /**
     * 地区名称
     */
    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String regionName;
    
    /**
     * 分配时间
     */
    @Field(type = FieldType.Date, format = DateFormat.date_time)
    private LocalDateTime allocatedTime;
    
    /**
     * 激活时间
     */
    @Field(type = FieldType.Date, format = DateFormat.date_time)
    private LocalDateTime activatedTime;
    
    /**
     * 创建时间
     */
    @Field(type = FieldType.Date, format = DateFormat.date_time)
    private LocalDateTime createTime;
    
    /**
     * 更新时间
     */
    @Field(type = FieldType.Date, format = DateFormat.date_time)
    private LocalDateTime updateTime;
    
    /**
     * 标签
     */
    @Field(type = FieldType.Keyword)
    private List<String> tags;
    
    /**
     * 备注
     */
    @Field(type = FieldType.Text, analyzer = "ik_max_word")
    private String remarks;
}
```

## 搜索服务实现

### 1. 基础搜索服务

```java
/**
 * 基础搜索服务
 */
@Service
@Slf4j
public class BaseSearchService {
    
    @Autowired
    private ElasticsearchRestTemplate elasticsearchTemplate;
    
    @Autowired
    private ElasticsearchClient elasticsearchClient;
    
    /**
     * 通用搜索方法
     */
    public <T> SearchResponse<T> search(SearchRequest searchRequest, Class<T> clazz) {
        try {
            // 构建查询
            Query query = buildQuery(searchRequest);
            
            // 执行搜索
            SearchHits<T> searchHits = elasticsearchTemplate.search(query, clazz);
            
            // 构建响应
            return buildSearchResponse(searchHits, searchRequest);
            
        } catch (Exception e) {
            log.error("Search failed: indexName={}, keyword={}", 
                searchRequest.getIndexName(), searchRequest.getKeyword(), e);
            throw new SearchException("Search operation failed", e);
        }
    }
    
    /**
     * 构建查询
     */
    private Query buildQuery(SearchRequest searchRequest) {
        NativeSearchQueryBuilder queryBuilder = new NativeSearchQueryBuilder();
        
        // 设置索引
        if (StringUtils.hasText(searchRequest.getIndexName())) {
            queryBuilder.withIndices(searchRequest.getIndexName());
        }
        
        // 构建查询条件
        BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
        
        // 关键词搜索
        if (StringUtils.hasText(searchRequest.getKeyword())) {
            QueryBuilder keywordQuery = buildKeywordQuery(searchRequest);
            boolQuery.must(keywordQuery);
        }
        
        // 过滤条件
        if (searchRequest.getFilters() != null && !searchRequest.getFilters().isEmpty()) {
            for (Map.Entry<String, Object> filter : searchRequest.getFilters().entrySet()) {
                boolQuery.filter(QueryBuilders.termQuery(filter.getKey(), filter.getValue()));
            }
        }
        
        queryBuilder.withQuery(boolQuery);
        
        // 排序
        if (searchRequest.getSortFields() != null && !searchRequest.getSortFields().isEmpty()) {
            for (SortField sortField : searchRequest.getSortFields()) {
                SortOrder order = sortField.isAsc() ? SortOrder.ASC : SortOrder.DESC;
                queryBuilder.withSort(SortBuilders.fieldSort(sortField.getField()).order(order));
            }
        }
        
        // 分页
        if (searchRequest.getPageRequest() != null) {
            PageRequest pageRequest = searchRequest.getPageRequest();
            queryBuilder.withPageable(PageRequest.of(
                pageRequest.getPageNumber(), 
                pageRequest.getPageSize()));
        }
        
        // 聚合
        if (searchRequest.getAggregations() != null && !searchRequest.getAggregations().isEmpty()) {
            for (AggregationQuery aggQuery : searchRequest.getAggregations()) {
                AggregationBuilder aggregation = buildAggregation(aggQuery);
                queryBuilder.addAggregation(aggregation);
            }
        }
        
        // 高亮
        if (searchRequest.getHighlightFields() != null && !searchRequest.getHighlightFields().isEmpty()) {
            HighlightBuilder highlightBuilder = new HighlightBuilder();
            for (String field : searchRequest.getHighlightFields()) {
                highlightBuilder.field(field)
                    .preTags("<em>")
                    .postTags("</em>")
                    .fragmentSize(100)
                    .numOfFragments(3);
            }
            queryBuilder.withHighlightBuilder(highlightBuilder);
        }
        
        // 源字段过滤
        if (searchRequest.getIncludeSource() != null && !searchRequest.getIncludeSource()) {
            queryBuilder.withSourceFilter(new FetchSourceFilterBuilder()
                .withIncludes(searchRequest.getIncludeFields())
                .withExcludes(searchRequest.getExcludeFields())
                .build());
        }
        
        // 超时设置
        if (searchRequest.getTimeoutMs() != null) {
            queryBuilder.withTimeout(Duration.ofMillis(searchRequest.getTimeoutMs()));
        }
        
        return queryBuilder.build();
    }
    
    /**
     * 构建关键词查询
     */
    private QueryBuilder buildKeywordQuery(SearchRequest searchRequest) {
        String keyword = searchRequest.getKeyword();
        List<String> searchFields = searchRequest.getSearchFields();
        SearchType searchType = searchRequest.getSearchType();
        
        switch (searchType) {
            case EXACT_MATCH:
                if (searchFields != null && !searchFields.isEmpty()) {
                    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
                    for (String field : searchFields) {
                        boolQuery.should(QueryBuilders.termQuery(field, keyword));
                    }
                    return boolQuery;
                } else {
                    return QueryBuilders.termQuery("_all", keyword);
                }
                
            case FUZZY_SEARCH:
                if (searchFields != null && !searchFields.isEmpty()) {
                    MultiMatchQueryBuilder multiMatchQuery = QueryBuilders.multiMatchQuery(keyword)
                        .fuzziness(Fuzziness.AUTO)
                        .prefixLength(2)
                        .maxExpansions(10);
                    for (String field : searchFields) {
                        multiMatchQuery.field(field);
                    }
                    return multiMatchQuery;
                } else {
                    return QueryBuilders.fuzzyQuery("_all", keyword)
                        .fuzziness(Fuzziness.AUTO);
                }
                
            case PREFIX_MATCH:
                if (searchFields != null && !searchFields.isEmpty()) {
                    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
                    for (String field : searchFields) {
                        boolQuery.should(QueryBuilders.prefixQuery(field, keyword));
                    }
                    return boolQuery;
                } else {
                    return QueryBuilders.prefixQuery("_all", keyword);
                }
                
            case WILDCARD_SEARCH:
                if (searchFields != null && !searchFields.isEmpty()) {
                    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
                    for (String field : searchFields) {
                        boolQuery.should(QueryBuilders.wildcardQuery(field, keyword));
                    }
                    return boolQuery;
                } else {
                    return QueryBuilders.wildcardQuery("_all", keyword);
                }
                
            case REGEX_SEARCH:
                if (searchFields != null && !searchFields.isEmpty()) {
                    BoolQueryBuilder boolQuery = QueryBuilders.boolQuery();
                    for (String field : searchFields) {
                        boolQuery.should(QueryBuilders.regexpQuery(field, keyword));
                    }
                    return boolQuery;
                } else {
                    return QueryBuilders.regexpQuery("_all", keyword);
                }
                
            case FULL_TEXT_SEARCH:
            default:
                if (searchFields != null && !searchFields.isEmpty()) {
                    return QueryBuilders.multiMatchQuery(keyword)
                        .fields(searchFields.stream()
                            .collect(Collectors.toMap(field -> field, field -> 1.0f)))
                        .type(MultiMatchQueryBuilder.Type.BEST_FIELDS)
                        .operator(Operator.AND);
                } else {
                    return QueryBuilders.matchQuery("_all", keyword)
                        .operator(Operator.AND);
                }
        }
    }
    
    /**
     * 构建聚合查询
     */
    private AggregationBuilder buildAggregation(AggregationQuery aggQuery) {
        String name = aggQuery.getName();
        String field = aggQuery.getField();
        AggregationType type = aggQuery.getType();
        
        switch (type) {
            case COUNT:
                return AggregationBuilders.count(name).field(field);
            case SUM:
                return AggregationBuilders.sum(name).field(field);
            case AVG:
                return AggregationBuilders.avg(name).field(field);
            case MAX:
                return AggregationBuilders.max(name).field(field);
            case MIN:
                return AggregationBuilders.min(name).field(field);
            case TERMS:
                return AggregationBuilders.terms(name).field(field)
                    .size(aggQuery.getSize() != null ? aggQuery.getSize() : 10);
            case DATE_HISTOGRAM:
                return AggregationBuilders.dateHistogram(name).field(field)
                    .calendarInterval(DateHistogramInterval.DAY);
            case RANGE:
                RangeAggregationBuilder rangeAgg = AggregationBuilders.range(name).field(field);
                if (aggQuery.getRanges() != null) {
                    for (AggregationRange range : aggQuery.getRanges()) {
                        rangeAgg.addRange(range.getKey(), range.getFrom(), range.getTo());
                    }
                }
                return rangeAgg;
            case PERCENTILES:
                return AggregationBuilders.percentiles(name).field(field);
            default:
                throw new IllegalArgumentException("Unsupported aggregation type: " + type);
        }
    }
    
    /**
     * 构建搜索响应
     */
    private <T> SearchResponse<T> buildSearchResponse(SearchHits<T> searchHits, 
                                                    SearchRequest searchRequest) {
        List<SearchHit<T>> hits = searchHits.getSearchHits().stream()
            .map(hit -> SearchHit.<T>builder()
                .id(hit.getId())
                .score(hit.getScore())
                .content(hit.getContent())
                .highlightFields(hit.getHighlightFields())
                .build())
            .collect(Collectors.toList());
        
        // 分页信息
        PageInfo pageInfo = null;
        if (searchRequest.getPageRequest() != null) {
            PageRequest pageRequest = searchRequest.getPageRequest();
            pageInfo = PageInfo.builder()
                .pageNumber(pageRequest.getPageNumber())
                .pageSize(pageRequest.getPageSize())
                .totalElements(searchHits.getTotalHits())
                .totalPages((int) Math.ceil((double) searchHits.getTotalHits() / pageRequest.getPageSize()))
                .build();
        }
        
        return SearchResponse.<T>builder()
            .hits(hits)
            .totalHits(searchHits.getTotalHits())
            .maxScore(searchHits.getMaxScore())
            .took(0L) // TODO: 获取实际耗时
            .timedOut(false)
            .aggregations(extractAggregations(searchHits))
            .pageInfo(pageInfo)
            .build();
    }
    
    /**
     * 提取聚合结果
     */
    private Map<String, Object> extractAggregations(SearchHits<?> searchHits) {
        Map<String, Object> aggregations = new HashMap<>();
        
        if (searchHits.hasAggregations()) {
            Aggregations aggs = searchHits.getAggregations();
            for (Aggregation agg : aggs) {
                aggregations.put(agg.getName(), extractAggregationValue(agg));
            }
        }
        
        return aggregations;
    }
    
    /**
     * 提取聚合值
     */
    private Object extractAggregationValue(Aggregation aggregation) {
        if (aggregation instanceof Terms) {
            Terms terms = (Terms) aggregation;
            return terms.getBuckets().stream()
                .collect(Collectors.toMap(
                    Terms.Bucket::getKeyAsString,
                    Terms.Bucket::getDocCount));
        } else if (aggregation instanceof SingleValue) {
            return ((SingleValue) aggregation).value();
        } else if (aggregation instanceof Range) {
            Range range = (Range) aggregation;
            return range.getBuckets().stream()
                .collect(Collectors.toMap(
                    Range.Bucket::getKeyAsString,
                    Range.Bucket::getDocCount));
        }
        return null;
    }
}
```

### 2. IMSI资源搜索服务

```java
/**
 * IMSI资源搜索服务
 */
@Service
@Slf4j
public class ImsiResourceSearchService {
    
    @Autowired
    private BaseSearchService baseSearchService;
    
    @Autowired
    private ElasticsearchRestTemplate elasticsearchTemplate;
    
    /**
     * 搜索IMSI资源
     */
    public SearchResponse<ImsiResourceDocument> searchImsiResources(
            String keyword, List<String> statuses, String supplierId, 
            String regionCode, LocalDateTime startTime, LocalDateTime endTime,
            int page, int size) {
        
        SearchRequest searchRequest = SearchRequest.builder()
            .indexName(IndexType.IMSI_RESOURCE.getIndexName())
            .keyword(keyword)
            .searchType(SearchType.FULL_TEXT_SEARCH)
            .searchFields(Arrays.asList("imsi", "supplierName", "regionName", "remarks"))
            .filters(buildFilters(statuses, supplierId, regionCode, startTime, endTime))
            .sortFields(Arrays.asList(
                SortField.builder().field("createTime").asc(false).build()))
            .pageRequest(PageRequest.of(page, size))
            .highlightFields(Arrays.asList("imsi", "supplierName", "regionName"))
            .timeoutMs(5000L)
            .build();
        
        return baseSearchService.search(searchRequest, ImsiResourceDocument.class);
    }
    
    /**
     * 根据IMSI精确查找
     */
    public ImsiResourceDocument findByImsi(String imsi) {
        SearchRequest searchRequest = SearchRequest.builder()
            .indexName(IndexType.IMSI_RESOURCE.getIndexName())
            .keyword(imsi)
            .searchType(SearchType.EXACT_MATCH)
            .searchFields(Arrays.asList("imsi"))
            .pageRequest(PageRequest.of(0, 1))
            .build();
        
        SearchResponse<ImsiResourceDocument> response = 
            baseSearchService.search(searchRequest, ImsiResourceDocument.class);
        
        return response.getHits().isEmpty() ? null : response.getHits().get(0).getContent();
    }
    
    /**
     * 统计IMSI资源分布
     */
    public Map<String, Object> getImsiResourceStatistics() {
        SearchRequest searchRequest = SearchRequest.builder()
            .indexName(IndexType.IMSI_RESOURCE.getIndexName())
            .aggregations(Arrays.asList(
                // 按状态统计
                AggregationQuery.builder()
                    .name("status_stats")
                    .field("status")
                    .type(AggregationType.TERMS)
                    .size(10)
                    .build(),
                // 按供应商统计
                AggregationQuery.builder()
                    .name("supplier_stats")
                    .field("supplierId")
                    .type(AggregationType.TERMS)
                    .size(20)
                    .build(),
                // 按地区统计
                AggregationQuery.builder()
                    .name("region_stats")
                    .field("regionCode")
                    .type(AggregationType.TERMS)
                    .size(50)
                    .build(),
                // 按创建时间统计
                AggregationQuery.builder()
                    .name("create_time_stats")
                    .field("createTime")
                    .type(AggregationType.DATE_HISTOGRAM)
                    .build()
            ))
            .pageRequest(PageRequest.of(0, 0)) // 只要聚合结果
            .build();
        
        SearchResponse<ImsiResourceDocument> response = 
            baseSearchService.search(searchRequest, ImsiResourceDocument.class);
        
        return response.getAggregations();
    }
    
    /**
     * 构建过滤条件
     */
    private Map<String, Object> buildFilters(List<String> statuses, String supplierId, 
                                           String regionCode, LocalDateTime startTime, 
                                           LocalDateTime endTime) {
        Map<String, Object> filters = new HashMap<>();
        
        if (statuses != null && !statuses.isEmpty()) {
            filters.put("status", statuses);
        }
        
        if (StringUtils.hasText(supplierId)) {
            filters.put("supplierId", supplierId);
        }
        
        if (StringUtils.hasText(regionCode)) {
            filters.put("regionCode", regionCode);
        }
        
        // 时间范围过滤需要特殊处理
        if (startTime != null || endTime != null) {
            Map<String, Object> timeRange = new HashMap<>();
            if (startTime != null) {
                timeRange.put("gte", startTime);
            }
            if (endTime != null) {
                timeRange.put("lte", endTime);
            }
            filters.put("createTime", timeRange);
        }
        
        return filters;
    }
    
    /**
     * 同步IMSI资源到搜索引擎
     */
    @Async
    public void syncImsiResource(ImsiResource imsiResource) {
        try {
            ImsiResourceDocument document = convertToDocument(imsiResource);
            elasticsearchTemplate.save(document);
            log.info("IMSI resource synced to search engine: imsi={}", imsiResource.getImsi());
        } catch (Exception e) {
            log.error("Failed to sync IMSI resource to search engine: imsi={}", 
                imsiResource.getImsi(), e);
        }
    }
    
    /**
     * 转换为搜索文档
     */
    private ImsiResourceDocument convertToDocument(ImsiResource imsiResource) {
        return ImsiResourceDocument.builder()
            .id(imsiResource.getId().toString())
            .imsi(imsiResource.getImsi())
            .status(imsiResource.getStatus().getCode())
            .userId(imsiResource.getUserId())
            .supplierId(imsiResource.getSupplierId())
            .supplierName(imsiResource.getSupplier() != null ? 
                imsiResource.getSupplier().getSupplierName() : null)
            .numberSegment(imsiResource.getNumberSegment())
            .regionCode(imsiResource.getRegionCode())
            .regionName(imsiResource.getRegionName())
            .allocatedTime(imsiResource.getAllocatedTime())
            .activatedTime(imsiResource.getActivatedTime())
            .createTime(imsiResource.getCreateTime())
            .updateTime(imsiResource.getUpdateTime())
            .tags(imsiResource.getTags())
            .remarks(imsiResource.getRemarks())
            .build();
    }
}
```

## 业务场景应用

### 1. 搜索控制器

```java
/**
 * 搜索控制器
 */
@RestController
@RequestMapping("/api/search")
@Slf4j
public class SearchController {
    
    @Autowired
    private ImsiResourceSearchService imsiResourceSearchService;
    
    @Autowired
    private SimCardSearchService simCardSearchService;
    
    /**
     * 搜索IMSI资源
     */
    @GetMapping("/imsi")
    public ApiResponse<SearchResponse<ImsiResourceDocument>> searchImsiResources(
            @RequestParam(required = false) String keyword,
            @RequestParam(required = false) List<String> statuses,
            @RequestParam(required = false) String supplierId,
            @RequestParam(required = false) String regionCode,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime startTime,
            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) LocalDateTime endTime,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "20") int size) {
        
        try {
            SearchResponse<ImsiResourceDocument> response = imsiResourceSearchService
                .searchImsiResources(keyword, statuses, supplierId, regionCode, 
                                   startTime, endTime, page, size);
            
            return ApiResponse.success(response);
            
        } catch (Exception e) {
            log.error("Failed to search IMSI resources", e);
            return ApiResponse.error("搜索IMSI资源失败: " + e.getMessage());
        }
    }
    
    /**
     * 根据IMSI查找资源
     */
    @GetMapping("/imsi/{imsi}")
    public ApiResponse<ImsiResourceDocument> findImsiByNumber(@PathVariable String imsi) {
        try {
            ImsiResourceDocument document = imsiResourceSearchService.findByImsi(imsi);
            
            if (document != null) {
                return ApiResponse.success(document);
            } else {
                return ApiResponse.error("IMSI资源不存在");
            }
            
        } catch (Exception e) {
            log.error("Failed to find IMSI resource: imsi={}", imsi, e);
            return ApiResponse.error("查找IMSI资源失败: " + e.getMessage());
        }
    }
    
    /**
     * 获取IMSI资源统计
     */
    @GetMapping("/imsi/statistics")
    public ApiResponse<Map<String, Object>> getImsiResourceStatistics() {
        try {
            Map<String, Object> statistics = imsiResourceSearchService.getImsiResourceStatistics();
            return ApiResponse.success(statistics);
            
        } catch (Exception e) {
            log.error("Failed to get IMSI resource statistics", e);
            return ApiResponse.error("获取IMSI资源统计失败: " + e.getMessage());
        }
    }
    
    /**
     * 全局搜索
     */
    @GetMapping("/global")
    public ApiResponse<Map<String, Object>> globalSearch(
            @RequestParam String keyword,
            @RequestParam(defaultValue = "0") int page,
            @RequestParam(defaultValue = "10") int size) {
        
        try {
            Map<String, Object> results = new HashMap<>();
            
            // 搜索IMSI资源
            SearchResponse<ImsiResourceDocument> imsiResults = imsiResourceSearchService
                .searchImsiResources(keyword, null, null, null, null, null, page, size);
            results.put("imsiResources", imsiResults);
            
            // 搜索SIM卡
            SearchResponse<SimCardDocument> simResults = simCardSearchService
                .searchSimCards(keyword, null, null, null, null, page, size);
            results.put("simCards", simResults);
            
            return ApiResponse.success(results);
            
        } catch (Exception e) {
            log.error("Global search failed: keyword={}", keyword, e);
            return ApiResponse.error("全局搜索失败: " + e.getMessage());
        }
    }
}
```

### 2. 数据同步监听器

```java
/**
 * 数据同步监听器
 */
@Component
@Slf4j
public class SearchDataSyncListener {
    
    @Autowired
    private ImsiResourceSearchService imsiResourceSearchService;
    
    @Autowired
    private SimCardSearchService simCardSearchService;
    
    /**
     * 监听IMSI资源变更
     */
    @EventListener
    @Async
    public void handleImsiResourceChanged(ImsiResourceChangedEvent event) {
        try {
            ImsiResource imsiResource = event.getImsiResource();
            String operation = event.getOperation();
            
            switch (operation) {
                case "CREATE":
                case "UPDATE":
                    imsiResourceSearchService.syncImsiResource(imsiResource);
                    break;
                case "DELETE":
                    imsiResourceSearchService.deleteImsiResource(imsiResource.getId());
                    break;
                default:
                    log.warn("Unknown operation: {}", operation);
            }
            
        } catch (Exception e) {
            log.error("Failed to sync IMSI resource to search engine", e);
        }
    }
    
    /**
     * 监听SIM卡变更
     */
    @EventListener
    @Async
    public void handleSimCardChanged(SimCardChangedEvent event) {
        try {
            SimCard simCard = event.getSimCard();
            String operation = event.getOperation();
            
            switch (operation) {
                case "CREATE":
                case "UPDATE":
                    simCardSearchService.syncSimCard(simCard);
                    break;
                case "DELETE":
                    simCardSearchService.deleteSimCard(simCard.getId());
                    break;
                default:
                    log.warn("Unknown operation: {}", operation);
            }
            
        } catch (Exception e) {
            log.error("Failed to sync SIM card to search engine", e);
        }
    }
}
```

## Elasticsearch集群配置

### 1. 集群配置文件

```yaml
# elasticsearch.yml
cluster.name: nsrs-es-cluster
node.name: es-node-1
node.roles: [master, data, ingest]

# 网络配置
network.host: 0.0.0.0
http.port: 9200
transport.port: 9300

# 发现配置
discovery.seed_hosts: ["es-node-1:9300", "es-node-2:9300", "es-node-3:9300"]
cluster.initial_master_nodes: ["es-node-1", "es-node-2", "es-node-3"]

# 路径配置
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch

# 内存配置
bootstrap.memory_lock: true

# 安全配置
xpack.security.enabled: true
xpack.security.transport.ssl.enabled: true
xpack.security.http.ssl.enabled: true

# 监控配置
xpack.monitoring.collection.enabled: true
```

### 2. JVM配置

```bash
# jvm.options
-Xms4g
-Xmx4g

# GC配置
-XX:+UseG1GC
-XX:G1HeapRegionSize=16m
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200

# 内存配置
-XX:+AlwaysPreTouch
-Xss1m
-Djava.awt.headless=true

# 文件描述符
-Dfile.encoding=UTF-8
-Djna.nosys=true
-Dio.netty.noUnsafe=true
-Dio.netty.noKeySetOptimization=true
```

### 3. Docker Compose配置

```yaml
# docker-compose.yml
version: '3.8'
services:
  es-node-1:
    image: elasticsearch:8.8.0
    container_name: es-node-1
    environment:
      - node.name=es-node-1
      - cluster.name=nsrs-es-cluster
      - discovery.seed_hosts=es-node-2,es-node-3
      - cluster.initial_master_nodes=es-node-1,es-node-2,es-node-3
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es-data-1:/usr/share/elasticsearch/data
      - es-logs-1:/usr/share/elasticsearch/logs
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - es-network

  es-node-2:
    image: elasticsearch:8.8.0
    container_name: es-node-2
    environment:
      - node.name=es-node-2
      - cluster.name=nsrs-es-cluster
      - discovery.seed_hosts=es-node-1,es-node-3
      - cluster.initial_master_nodes=es-node-1,es-node-2,es-node-3
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es-data-2:/usr/share/elasticsearch/data
      - es-logs-2:/usr/share/elasticsearch/logs
    ports:
      - "9201:9200"
      - "9301:9300"
    networks:
      - es-network

  es-node-3:
    image: elasticsearch:8.8.0
    container_name: es-node-3
    environment:
      - node.name=es-node-3
      - cluster.name=nsrs-es-cluster
      - discovery.seed_hosts=es-node-1,es-node-2
      - cluster.initial_master_nodes=es-node-1,es-node-2,es-node-3
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es-data-3:/usr/share/elasticsearch/data
      - es-logs-3:/usr/share/elasticsearch/logs
    ports:
      - "9202:9200"
      - "9302:9300"
    networks:
      - es-network

  kibana:
    image: kibana:8.8.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://es-node-1:9200
    ports:
      - "5601:5601"
    networks:
      - es-network
    depends_on:
      - es-node-1
      - es-node-2
      - es-node-3

volumes:
  es-data-1:
  es-data-2:
  es-data-3:
  es-logs-1:
  es-logs-2:
  es-logs-3:

networks:
  es-network:
    driver: bridge
```

## 性能优化

### 1. 索引优化

```json
{
  "settings": {
    "number_of_shards": 3,
    "number_of_replicas": 1,
    "refresh_interval": "30s",
    "index": {
      "max_result_window": 50000,
      "mapping": {
        "total_fields": {
          "limit": 2000
        }
      },
      "analysis": {
        "analyzer": {
          "ik_analyzer": {
            "type": "custom",
            "tokenizer": "ik_max_word",
            "filter": ["lowercase", "stop"]
          }
        }
      }
    }
  },
  "mappings": {
    "properties": {
      "imsi": {
        "type": "keyword",
        "index": true
      },
      "status": {
        "type": "keyword",
        "index": true
      },
      "supplierName": {
        "type": "text",
        "analyzer": "ik_analyzer",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "createTime": {
        "type": "date",
        "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"
      }
    }
  }
}
```

### 2. 查询优化

```java
/**
 * 查询优化服务
 */
@Service
public class SearchOptimizationService {
    
    /**
     * 使用滚动搜索处理大量数据
     */
    public List<ImsiResourceDocument> scrollSearch(String keyword, int batchSize) {
        List<ImsiResourceDocument> allResults = new ArrayList<>();
        
        SearchRequest searchRequest = new SearchRequest("imsi_resource");
        SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
        sourceBuilder.query(QueryBuilders.matchQuery("supplierName", keyword));
        sourceBuilder.size(batchSize);
        searchRequest.source(sourceBuilder);
        searchRequest.scroll(TimeValue.timeValueMinutes(1L));
        
        try {
            SearchResponse searchResponse = client.search(searchRequest, RequestOptions.DEFAULT);
            String scrollId = searchResponse.getScrollId();
            SearchHit[] searchHits = searchResponse.getHits().getHits();
            
            while (searchHits != null && searchHits.length > 0) {
                for (SearchHit hit : searchHits) {
                    ImsiResourceDocument doc = JSON.parseObject(
                        hit.getSourceAsString(), ImsiResourceDocument.class);
                    allResults.add(doc);
                }
                
                SearchScrollRequest scrollRequest = new SearchScrollRequest(scrollId);
                scrollRequest.scroll(TimeValue.timeValueMinutes(1L));
                searchResponse = client.scroll(scrollRequest, RequestOptions.DEFAULT);
                scrollId = searchResponse.getScrollId();
                searchHits = searchResponse.getHits().getHits();
            }
            
            // 清理滚动上下文
            ClearScrollRequest clearScrollRequest = new ClearScrollRequest();
            clearScrollRequest.addScrollId(scrollId);
            client.clearScroll(clearScrollRequest, RequestOptions.DEFAULT);
            
        } catch (Exception e) {
            log.error("Scroll search failed", e);
        }
        
        return allResults;
    }
    
    /**
     * 使用搜索模板
     */
    public SearchResponse<ImsiResourceDocument> searchWithTemplate(
            String templateId, Map<String, Object> params) {
        
        SearchTemplateRequest request = new SearchTemplateRequest();
        request.setRequest(new SearchRequest("imsi_resource"));
        request.setScriptType(ScriptType.STORED);
        request.setScript(templateId);
        request.setScriptParams(params);
        
        try {
            SearchTemplateResponse response = client.searchTemplate(request, RequestOptions.DEFAULT);
            return convertToSearchResponse(response.getResponse());
        } catch (Exception e) {
            log.error("Template search failed: templateId={}", templateId, e);
            throw new SearchException("Template search failed", e);
        }
    }
}
```

## 最佳实践

### 1. 索引设计原则

#### 分片策略
- **分片数量**: 根据数据量和查询负载确定，一般每个分片20-50GB
- **副本数量**: 至少1个副本，提高查询性能和可用性
- **分片分配**: 避免热点，均匀分布到各个节点

#### 映射设计
```java
// 合理设计字段类型
@Field(type = FieldType.Keyword)  // 精确匹配字段
private String imsi;

@Field(type = FieldType.Text, analyzer = "ik_max_word")  // 全文搜索字段
private String description;

@Field(type = FieldType.Date, format = DateFormat.date_time)  // 日期字段
private LocalDateTime createTime;

@Field(type = FieldType.Nested)  // 嵌套对象
private List<Tag> tags;
```

### 2. 查询优化

#### 查询缓存
```java
// 启用查询缓存
SearchSourceBuilder sourceBuilder = new SearchSourceBuilder();
sourceBuilder.query(QueryBuilders.termQuery("status", "ACTIVE"));
sourceBuilder.requestCache(true);  // 启用请求缓存
```

#### 字段过滤
```java
// 只返回需要的字段
sourceBuilder.fetchSource(
    new String[]{"imsi", "status", "createTime"},  // 包含字段
    new String[]{"remarks", "tags"}               // 排除字段
);
```

### 3. 监控告警

```yaml
# Prometheus监控规则
groups:
  - name: elasticsearch.rules
    rules:
      - alert: ElasticsearchClusterRed
        expr: elasticsearch_cluster_health_status{color="red"} == 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Elasticsearch集群状态异常"
          description: "集群状态为红色，存在不可用分片"
      
      - alert: ElasticsearchHighQueryLatency
        expr: elasticsearch_indices_search_query_time_seconds > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Elasticsearch查询延迟过高"
          description: "查询延迟超过1秒"
```

### 4. 数据生命周期管理

```json
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "50GB",
            "max_age": "30d"
          }
        }
      },
      "warm": {
        "min_age": "30d",
        "actions": {
          "allocate": {
            "number_of_replicas": 0
          },
          "forcemerge": {
            "max_num_segments": 1
          }
        }
      },
      "cold": {
        "min_age": "90d",
        "actions": {
          "allocate": {
            "number_of_replicas": 0
          }
        }
      },
      "delete": {
        "min_age": "365d"
      }
    }
  }
}
```

通过以上搜索引擎架构设计，NSRS号卡资源管理系统实现了高效的全文搜索、实时数据同步、复杂聚合分析等功能，为业务查询和数据分析提供了强大的技术支撑。